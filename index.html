<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventaire Project Zomboid</title>

  <!-- Librairies externes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

  <!-- Style intégré -->
  <style>
    :root {
      --primary: #c62828;
      --background: #121212;
      --surface: #1e1e1e;
      --text: #f5f5f5;
      --text-secondary: #b0b0b0;
      --radius: 8px;
    }

    [data-theme="light"] {
      --background: #ffffff;
      --surface: #f0f0f0;
      --text: #212121;
      --text-secondary: #666666;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background-color: var(--background);
      color: var(--text);
    }

    header {
      background-color: var(--primary);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
      color: white;
    }

    header button {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    section {
      background-color: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
      border-bottom: 1px solid var(--text-secondary);
      padding-bottom: 5px;
    }

    #qrcode {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 15px;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: var(--radius);
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #a92222;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--surface);
      color: var(--text);
      padding: 12px 18px;
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 10000;
    }

    .toast.show {
      display: flex;
    }

    #resource-map {
      width: 100%;
      height: 400px;
      border-radius: var(--radius);
    }

    /* Ajoute ici d'autres styles selon tes sections : modales, filtres, inventaire, etc. */
  </style>
</head>

<body data-theme="dark">
  <!-- En-tête -->
  <header>
    <h1>Inventaire Zomboid</h1>
    <button id="theme-toggle-btn" title="Changer de thème">
      <i class="fas fa-moon"></i>
    </button>
  </header>

  <!-- Contenu principal -->
  <main>

    <!-- Section Inventaire -->
    <section id="inventory-section">
      <h2>Inventaire</h2>
      <div id="inventory">
        <!-- Le contenu est généré dynamiquement par JS -->
      </div>
    </section>

    <!-- Section Crafting -->
    <section id="crafting-section">
      <h2>Crafting</h2>
      <div id="recipe-container">
        <!-- Recettes affichées ici -->
      </div>
    </section>

    <!-- Section QR Code de partage -->
    <section id="qrcode-section">
      <h2>QR Code Partage</h2>
      <button id="generate-qrcode-btn">
        Générer QR Code
      </button>
      <div id="qrcode"></div>
    </section>

    <!-- Section Carte interactive -->
    <section id="map-section">
      <h2>Carte Interactive</h2>
      <div id="resource-map"></div>
    </section>

  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i class="fas fa-check-circle fa-lg"></i>
    <div id="toast-message"></div>
  </div>

  <!-- Dépendances JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- Script principal -->
  <script>
    // --- Configuration Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyASp6Gfi4Fz8Nduap0on89oAZzCkPLKpFc",
      authDomain: "lions-890e9.firebaseapp.com",
      databaseURL: "https://lions-890e9-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lions-890e9",
      storageBucket: "lions-890e9.appspot.com",
      messagingSenderId: "560777699926",
      appId: "1:560777699926:web:2e256d3d1d337513be91f7",
      measurementId: "G-ZX3N3XWJ4K"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // --- Variables globales ---
    let currentRoomId = null;
    let currentStorage = 'main';
    let inventoryRef = null;
    let mapMarkersRef = null;
    let userName = 'Survivant';

    // --- Toast Notification ---
    function showToast(title, message, type = "success") {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      if (!toast || !toastMessage) return;

      toastMessage.textContent = message;
      const icon = toast.querySelector('i');
      icon.className = "fas fa-info-circle fa-lg";
      if (type === "success") icon.className = "fas fa-check-circle fa-lg";
      if (type === "error") icon.className = "fas fa-exclamation-circle fa-lg";

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // --- Thème clair/sombre ---
    function toggleTheme() {
      const body = document.body;
      const theme = body.getAttribute('data-theme');
      const newTheme = theme === 'dark' ? 'light' : 'dark';
      body.setAttribute('data-theme', newTheme);

      const icon = document.getElementById('theme-toggle-btn');
      if (icon) {
        icon.innerHTML = newTheme === 'dark'
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
      }

      localStorage.setItem('theme', newTheme);
      showToast("Thème", `Thème ${newTheme === 'dark' ? 'sombre' : 'clair'} activé`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);

      const themeToggle = document.getElementById('theme-toggle-btn');
      if (themeToggle) {
        themeToggle.innerHTML = savedTheme === 'dark'
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
        themeToggle.addEventListener('click', toggleTheme);
      }

      // --- Initialisation de la room ---
      const params = new URLSearchParams(window.location.search);
      currentRoomId = params.get("room") || "default-room";
      userName = prompt("Ton pseudo ?") || "Survivant";

      inventoryRef = database.ref(`rooms/${currentRoomId}/inventory`);
      mapMarkersRef = database.ref(`rooms/${currentRoomId}/mapMarkers`);
    });

    // --- Rendu de l'inventaire ---
    function renderInventory(data) {
      const container = document.getElementById('inventory');
      if (!container || !data || !data[currentStorage]) return;

      container.innerHTML = '';
      const storage = data[currentStorage];

      for (const category in storage) {
        const items = storage[category] || [];

        if (items.length === 0) continue;

        const section = document.createElement('div');
        section.className = 'inventory-category';

        const title = document.createElement('h3');
        title.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        section.appendChild(title);

        const list = document.createElement('ul');
        list.className = 'inventory-list';

        items.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'inventory-item';
          li.innerHTML = `
            <strong>${item.name}</strong> (${item.count})
            <div class="actions">
              <button onclick="decreaseCount('${category}', ${index})"><i class="fas fa-minus"></i></button>
              <button onclick="increaseCount('${category}', ${index})"><i class="fas fa-plus"></i></button>
              <button onclick="removeItem('${category}', ${index})"><i class="fas fa-trash"></i></button>
            </div>
          `;
          list.appendChild(li);
        });

        section.appendChild(list);
        container.appendChild(section);
      }
    }

    // --- Ajouter un objet ---
    function addItem(name, category, count) {
      if (!inventoryRef) return;

      const item = {
        name,
        count,
        addedOn: firebase.database.ServerValue.TIMESTAMP
      };

      const catRef = inventoryRef.child(`${currentStorage}/${category}`);
      catRef.once('value', snapshot => {
        const items = snapshot.val() || [];
        const index = items.findIndex(i => i.name.toLowerCase() === name.toLowerCase());

        if (index !== -1) {
          items[index].count += count;
        } else {
          items.push(item);
        }

        catRef.set(items).then(() => {
          showToast("Ajouté", `${count} x ${name}`, "success");
        });
      });
    }

    // --- Supprimer un objet ---
    function removeItem(category, index) {
      const ref = inventoryRef.child(`${currentStorage}/${category}`);
      ref.once('value', snapshot => {
        const items = snapshot.val() || [];
        if (index >= 0 && index < items.length) {
          items.splice(index, 1);
          ref.set(items);
          showToast("Supprimé", "Objet retiré", "success");
        }
      });
    }

    // --- Modifier la quantité ---
    function increaseCount(category, index) {
      updateCount(category, index, 1);
    }

    function decreaseCount(category, index) {
      updateCount(category, index, -1);
    }

    function updateCount(category, index, delta) {
      const ref = inventoryRef.child(`${currentStorage}/${category}/${index}`);
      ref.once('value', snapshot => {
        const item = snapshot.val();
        if (!item) return;

        const newCount = (item.count || 0) + delta;
        if (newCount <= 0) {
          removeItem(category, index);
        } else {
          ref.update({ count: newCount });
        }
      });
    }

    // --- Filtres et recherche (si tu veux en ajouter plus tard) ---
    // À brancher avec des boutons ou une barre de recherche si besoin

    // --- Initialiser la carte Leaflet ---
    function initMap() {
      const mapEl = document.getElementById('resource-map');
      if (!mapEl) return;

      zomboidMap = L.map(mapEl).setView([0, 0], 2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(zomboidMap);

      loadMapMarkers();
    }

    // --- Charger les marqueurs depuis Firebase ---
    function loadMapMarkers() {
      if (!mapMarkersRef || !zomboidMap) return;

      mapMarkersRef.child(currentStorage).on('value', snapshot => {
        const markers = snapshot.val() || {};

        // Supprimer anciens marqueurs
        zomboidMap.eachLayer(layer => {
          if (layer instanceof L.Marker) zomboidMap.removeLayer(layer);
        });

        for (const key in markers) {
          const marker = markers[key];
          if (!marker.lat || !marker.lng) continue;

          L.marker([marker.lat, marker.lng])
            .addTo(zomboidMap)
            .bindPopup(`
              <strong>${marker.type}</strong><br>
              ${marker.description || ''}
              <br><em>Ajouté par ${marker.addedBy || 'inconnu'}</em>
            `);
        }
      });
    }

    // --- Ajouter un marqueur via clic ---
    function enableMapClick() {
      if (!zomboidMap) return;

      zomboidMap.on('click', function(e) {
        const type = prompt("Type de ressource (ex: loot, essence, danger)");
        if (!type) return;

        const description = prompt("Description (optionnelle)") || "";
        const markerData = {
          lat: e.latlng.lat,
          lng: e.latlng.lng,
          type,
          description,
          addedBy: userName,
          addedOn: firebase.database.ServerValue.TIMESTAMP
        };

        mapMarkersRef.child(currentStorage).push(markerData);
        showToast("Carte", "Marqueur ajouté !", "success");
      });
    }

    // --- QR Code de partage ---
    function generateQRCode() {
      const container = document.getElementById('qrcode');
      if (!container || !currentRoomId) return;

      container.innerHTML = '';
      const url = `${location.origin}${location.pathname}?room=${currentRoomId}`;

      new QRCode(container, {
        text: url,
        width: 200,
        height: 200,
        colorDark: "#c62828",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });

      showToast("QR Code", "QR Code généré", "success");
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      enableMapClick();

      const qrBtn = document.getElementById('generate-qrcode-btn');
      if (qrBtn) qrBtn.addEventListener('click', generateQRCode);
    });

    // --- Graphique de stats ---
    let resourcesChart = null;

    function initStatsChart() {
      const canvas = document.createElement('canvas');
      canvas.id = 'resources-chart';
      canvas.style.maxWidth = '100%';

      const section = document.createElement('section');
      section.innerHTML = '<h2>Statistiques des ressources</h2>';
      section.appendChild(canvas);

      const main = document.querySelector('main');
      if (main) main.appendChild(section);

      const ctx = canvas.getContext('2d');
      resourcesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Armes', 'Nourriture', 'Médicaments'],
          datasets: [{
            label: 'Quantité',
            data: [0, 0, 0],
            backgroundColor: ['#c62828', '#43a047', '#1e88e5']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updateStatsChart() {
      if (!resourcesChart || !inventoryRef) return;

      inventoryRef.once('value', snapshot => {
        const data = snapshot.val()?.[currentStorage] || {};
        let weapons = 0, food = 0, meds = 0;

        data.weapons?.forEach(i => weapons += i.count || 0);
        data.food?.forEach(i => food += i.count || 0);
        data.medicine?.forEach(i => meds += i.count || 0);

        resourcesChart.data.datasets[0].data = [weapons, food, meds];
        resourcesChart.update();
      });
    }

    // --- Initialisation des données ---
    document.addEventListener('DOMContentLoaded', () => {
      if (!inventoryRef) return;

      inventoryRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        renderInventory(data);
        updateStatsChart();
      });

      inventoryRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          const base = {
            weapons: [],
            food: [],
            medicine: [],
            tools: [],
            clothing: [],
            materials: [],
            ammunition: [],
            fuel: [],
            electronics: [],
            books: [],
            containers: [],
            other: []
          };
          inventoryRef.child(currentStorage).set(base);
        }
      });

      initStatsChart();
    });
  </script>
</body>
</html>
