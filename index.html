<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventaire Project Zomboid</title>

  <!-- STYLE -->
  <style>
    :root {
      --primary: #c62828;
      --background: #121212;
      --surface: #1e1e1e;
      --text: #f5f5f5;
      --text-secondary: #b0b0b0;
      --border-radius: 8px;
    }

    [data-theme="light"] {
      --background: #ffffff;
      --surface: #f0f0f0;
      --text: #212121;
      --text-secondary: #666666;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--background);
      color: var(--text);
    }

    header {
      background: var(--primary);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      padding: 20px;
      display: grid;
      gap: 20px;
    }

    section {
      background: var(--surface);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    #resource-map {
      height: 400px;
      width: 100%;
    }

    #qrcode {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    button {
      background: var(--primary);
      border: none;
      padding: 10px 20px;
      color: #fff;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #a42222;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--surface);
      color: var(--text);
      border-radius: var(--border-radius);
      padding: 15px;
      display: none;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      z-index: 9999;
    }

    .toast.show {
      display: flex;
    }
  </style>

  <!-- LIBRAIRIES -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>

<body data-theme="dark">
  <header>
    <h1>Inventaire Zomboid</h1>
    <button id="theme-toggle-btn"><i class="fas fa-moon"></i></button>
  </header>

  <main>
    <section id="inventory-section">
      <h2>Inventaire</h2>
      <div id="inventory"></div>
    </section>

    <section id="crafting-section">
      <h2>Crafting</h2>
      <div id="recipe-container"></div>
    </section>

    <section id="qrcode-section">
      <h2>QR Code Partage</h2>
      <button id="generate-qrcode-btn">Générer QR Code</button>
      <div id="qrcode"></div>
    </section>

    <section id="map-section">
      <h2>Carte Interactive</h2>
      <div id="resource-map"></div>
    </section>
  </main>

  <div id="toast" class="toast">
    <i class="fas fa-check-circle fa-lg"></i>
    <div id="toast-message"></div>
  </div>

  <!-- SCRIPT JS -->
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // Variables globales
    let currentRoomId = null;
    let currentStorage = 'main';
    let activeFilter = 'all';
    let searchQuery = '';
    let userName = 'Anonyme';
    let userPresenceRef = null;
    let inventoryRef = null;
    let storageLocationsRef = null;
    let activityLogRef = null;
    let storagePhotosRef = null;
    let mapMarkersRef = null;
    let inventoryHistoryRef = null;
    let categoryIcons = {
      weapons: "fa-crosshairs",
      food: "fa-apple-alt",
      medicine: "fa-plus-square",
      tools: "fa-wrench",
      clothing: "fa-tshirt",
      materials: "fa-boxes",
      ammunition: "fa-bomb",
      fuel: "fa-gas-pump",
      electronics: "fa-microchip",
      books: "fa-book",
      containers: "fa-box-open",
      other: "fa-question-circle"
    };
    let categoryNames = {
      weapons: "Armes",
      food: "Nourriture",
      medicine: "Médicaments",
      tools: "Outils",
      clothing: "Vêtements",
      materials: "Matériaux",
      ammunition: "Munitions",
      fuel: "Carburant",
      electronics: "Électronique",
      books: "Livres",
      containers: "Contenants",
      other: "Autres"
    };

    // Fonction pour afficher un toast
    function showToast(title, message, type = "success") {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');

      if (!toast || !toastMessage) return;

      const toastTitle = toast.querySelector('.toast-title');
      if (toastTitle) toastTitle.textContent = title;
      toastMessage.textContent = message;

      toast.className = "toast show";
      if (type === "success") {
        toast.classList.add("success");
        const icon = toast.querySelector('i');
        if (icon) icon.className = "fas fa-check-circle fa-lg";
      } else if (type === "error") {
        toast.classList.add("error");
        const icon = toast.querySelector('i');
        if (icon) icon.className = "fas fa-exclamation-circle fa-lg";
      } else if (type === "info") {
        toast.classList.add("info");
        const icon = toast.querySelector('i');
        if (icon) icon.className = "fas fa-info-circle fa-lg";
      }

      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // Fonction pour basculer le thème
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      document.body.setAttribute('data-theme', newTheme);
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      if (themeToggleBtn) {
        themeToggleBtn.innerHTML = newTheme === 'dark'
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
      }

      localStorage.setItem('theme', newTheme);
      showToast("Thème", `Thème ${newTheme === 'dark' ? 'sombre' : 'clair'} activé`, "success");
    }

    // Appliquer le thème au chargement
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);

      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      if (themeToggleBtn) {
        themeToggleBtn.innerHTML = savedTheme === 'dark'
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
        themeToggleBtn.addEventListener('click', toggleTheme);
      }
    });

    // Fonction pour rendre l'inventaire à partir des données
    function renderInventory(data) {
      const container = document.getElementById('inventory');
      if (!container || !data || !data[currentStorage]) return;

      container.innerHTML = '';
      const storage = data[currentStorage];

      for (const category in storage) {
        const items = storage[category];
        if (!items || items.length === 0) continue;

        const section = document.createElement('section');
        section.className = 'inventory-category';

        const title = document.createElement('h3');
        title.innerHTML = `<i class="fas ${categoryIcons[category]}"></i> ${categoryNames[category]}`;
        section.appendChild(title);

        const list = document.createElement('ul');
        list.className = 'inventory-list';

        items.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'inventory-item';
          li.innerHTML = `
            <strong>${item.name}</strong> (${item.count})
            <div class="actions">
              <button onclick="decreaseCount('${category}', ${index})"><i class="fas fa-minus"></i></button>
              <button onclick="increaseCount('${category}', ${index})"><i class="fas fa-plus"></i></button>
              <button onclick="removeItem('${category}', ${index})"><i class="fas fa-trash"></i></button>
            </div>
          `;
          list.appendChild(li);
        });

        section.appendChild(list);
        container.appendChild(section);
      }
    }

    // Ajouter un objet à l'inventaire
    function addItem(name, category, count, description = '', priority = 'normal') {
      if (!inventoryRef || !name || !category) return;

      const item = {
        name,
        count,
        description,
        priority,
        addedOn: firebase.database.ServerValue.TIMESTAMP
      };

      const categoryRef = inventoryRef.child(`${currentStorage}/${category}`);
      categoryRef.once('value', snapshot => {
        const items = snapshot.val() || [];
        const existingIndex = items.findIndex(i => i.name.toLowerCase() === name.toLowerCase());

        if (existingIndex !== -1) {
          items[existingIndex].count += count;
        } else {
          items.push(item);
        }

        categoryRef.set(items).then(() => {
          showToast("Ajouté", `${count} x ${name} ajouté`, "success");
        });
      });
    }

    // Supprimer un objet
    function removeItem(category, index) {
      if (!inventoryRef) return;
      const categoryRef = inventoryRef.child(`${currentStorage}/${category}`);
      categoryRef.once('value', snapshot => {
        const items = snapshot.val() || [];
        if (index >= 0 && index < items.length) {
          items.splice(index, 1);
          categoryRef.set(items);
          showToast("Supprimé", `Objet supprimé`, "success");
        }
      });
    }

    // Augmenter la quantité
    function increaseCount(category, index) {
      updateCount(category, index, 1);
    }

    // Diminuer la quantité
    function decreaseCount(category, index) {
      updateCount(category, index, -1);
    }

    function updateCount(category, index, delta) {
      const ref = inventoryRef.child(`${currentStorage}/${category}/${index}`);
      ref.once('value', snapshot => {
        const item = snapshot.val();
        if (!item) return;
        const newCount = (item.count || 0) + delta;
        if (newCount <= 0) {
          removeItem(category, index);
        } else {
          ref.update({ count: newCount });
        }
      });
    }

    // Mettre à jour les stats (totaux visibles)
    function updateStats(data) {
      if (!data || !data[currentStorage]) return;
      const storage = data[currentStorage];
      let total = 0;
      for (const category in storage) {
        storage[category].forEach(item => {
          total += item.count;
        });
      }
      const el = document.getElementById('total-items');
      if (el) el.textContent = total;
    }

    // Fonction pour générer un QR Code
    function generateQRCode() {
      const container = document.getElementById('qrcode');
      if (!container || !currentRoomId) return;

      container.innerHTML = '';
      const shareURL = `${location.origin}${location.pathname}?room=${currentRoomId}`;

      new QRCode(container, {
        text: shareURL,
        width: 200,
        height: 200,
        colorDark: "#c62828",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    // Rafraîchir l’inventaire depuis la BDD
    function refreshInventory() {
      if (!inventoryRef) return;
      inventoryRef.once('value').then(snapshot => {
        const data = snapshot.val();
        renderInventory(data);
        updateStats(data);
      });
    }

    // Initialisation complète
    document.addEventListener('DOMContentLoaded', () => {
      if (!firebase || !firebase.database) return;

      // Exemple de setup basique (à adapter plus tard)
      currentRoomId = 'demo-room';
      inventoryRef = database.ref(`rooms/${currentRoomId}/inventory`);
      inventoryRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          // créer inventaire vide
          const defaultInv = {
            weapons: [], food: [], medicine: [], tools: [], clothing: [],
            materials: [], ammunition: [], fuel: [], electronics: [],
            books: [], containers: [], other: []
          };
          inventoryRef.child(currentStorage).set(defaultInv);
        } else {
          renderInventory(snapshot.val());
          updateStats(snapshot.val());
        }
      });
    });
    // Initialisation de la carte avec Leaflet
    let zomboidMap = null;
    function initMap() {
      const mapElement = document.getElementById('resource-map');
      if (!mapElement) return;

      zomboidMap = L.map(mapElement).setView([0, 0], 2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 19
      }).addTo(zomboidMap);

      loadMapMarkers();
    }

    // Chargement des marqueurs depuis Firebase
    function loadMapMarkers() {
      if (!mapMarkersRef || !zomboidMap) return;

      mapMarkersRef.child(currentStorage).on('value', snapshot => {
        const markers = snapshot.val() || {};

        // Supprimer les anciens marqueurs
        zomboidMap.eachLayer(layer => {
          if (layer instanceof L.Marker) {
            zomboidMap.removeLayer(layer);
          }
        });

        for (const key in markers) {
          const marker = markers[key];
          const leafletMarker = L.marker([marker.lat, marker.lng])
            .addTo(zomboidMap)
            .bindPopup(`<strong>${marker.type}</strong><br>${marker.description}`);
        }
      });
    }

    // Ajouter un nouveau marqueur (clic utilisateur)
    function showMapMarkerForm(latlng) {
      const type = prompt("Type de marqueur (ex: food, danger, shelter):");
      const desc = prompt("Description de l'endroit:");

      if (!type || !desc) return;

      const markerData = {
        lat: latlng.lat,
        lng: latlng.lng,
        type,
        description: desc,
        addedBy: userName,
        addedOn: firebase.database.ServerValue.TIMESTAMP
      };

      mapMarkersRef.child(currentStorage).push(markerData);
      showToast("Carte", "Marqueur ajouté avec succès", "success");
    }

    // Écouteur de clic sur la carte
    function enableMapClick() {
      if (!zomboidMap) return;
      zomboidMap.on('click', function(e) {
        showMapMarkerForm(e.latlng);
      });
    }

    // Initialiser les graphiques statistiques
    let resourcesChart = null;
    function initStatsCharts() {
      const ctx = document.getElementById('resources-chart');
      if (!ctx) return;

      resourcesChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: ["Armes", "Nourriture", "Médicaments"],
          datasets: [{
            label: 'Ressources',
            data: [0, 0, 0],
            backgroundColor: ['#c62828', '#43a047', '#1e88e5']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      updateStatsCharts();
    }

    // Mettre à jour les données du graphique
    function updateStatsCharts() {
      if (!resourcesChart || !inventoryRef) return;

      inventoryRef.once('value', snapshot => {
        const data = snapshot.val() || {};
        let weapons = 0, food = 0, meds = 0;

        const storage = data[currentStorage];
        if (!storage) return;

        storage.weapons?.forEach(item => weapons += item.count || 0);
        storage.food?.forEach(item => food += item.count || 0);
        storage.medicine?.forEach(item => meds += item.count || 0);

        resourcesChart.data.datasets[0].data = [weapons, food, meds];
        resourcesChart.update();
      });
    }

    // Lancer la carte et les graphes quand la page est prête
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      enableMapClick();
      initStatsCharts();
    });
  </script>
</body>
</html>
