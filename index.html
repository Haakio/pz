<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventaire Project Zomboid</title>

  <!-- LIBRAIRIES -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <style>
    :root {
      --primary: #c62828;
      --background: #121212;
      --surface: #1e1e1e;
      --text: #f5f5f5;
      --text-secondary: #b0b0b0;
      --border-radius: 8px;
    }

    [data-theme="light"] {
      --background: #ffffff;
      --surface: #f0f0f0;
      --text: #212121;
      --text-secondary: #666666;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--background);
      color: var(--text);
    }

    header {
      background: var(--primary);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      padding: 20px;
      display: grid;
      gap: 20px;
    }

    section {
      background: var(--surface);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    #resource-map {
      height: 400px;
      width: 100%;
    }

    #qrcode {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    button {
      background: var(--primary);
      border: none;
      padding: 10px 20px;
      color: #fff;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #a42222;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--surface);
      color: var(--text);
      border-radius: var(--border-radius);
      padding: 15px;
      display: none;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      z-index: 9999;
    }

    .toast.show {
      display: flex;
    }

    .loader {
      display: none;
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <h1>Inventaire Zomboid</h1>
    <button id="theme-toggle-btn"><i class="fas fa-moon"></i></button>
  </header>

  <main>
    <section id="inventory-section">
      <h2>Inventaire</h2>
      <div id="inventory"></div>
    </section>

    <section id="crafting-section">
      <h2>Crafting</h2>
      <div id="recipe-container"></div>
    </section>

    <section id="qrcode-section">
      <h2>QR Code Partage</h2>
      <button id="generate-qrcode-btn">Générer QR Code</button>
      <div id="qrcode"></div>
    </section>

    <section id="map-section">
      <h2>Carte Interactive</h2>
      <div id="resource-map"></div>
    </section>
  </main>

  <div id="toast" class="toast">
    <i class="fas fa-check-circle fa-lg"></i>
    <div id="toast-message"></div>
  </div>

  <!-- LIBRAIRIES JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    // Configuration Firebase (remplace par tes infos si besoin)
    const firebaseConfig = {
      apiKey: "AIzaSyASp6Gfi4Fz8Nduap0on89oAZzCkPLKpFc",
      authDomain: "lions-890e9.firebaseapp.com",
      databaseURL: "https://lions-890e9-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lions-890e9",
      storageBucket: "lions-890e9.appspot.com",
      messagingSenderId: "560777699926",
      appId: "1:560777699926:web:2e256d3d1d337513be91f7",
      measurementId: "G-ZX3N3XWJ4K"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // Variables globales
    let currentRoomId = null;
    let currentStorage = 'main';
    let activeFilter = 'all';
    let searchQuery = '';
    let userName = 'Anonyme';
    let userPresenceRef = null;
    let inventoryRef = null;
    let storageLocationsRef = null;
    let activityLogRef = null;
    let storagePhotosRef = null;
    let mapMarkersRef = null;
    let inventoryHistoryRef = null;

    let zomboidMap = null;
    let resourcesChart = null;
    let categoriesChart = null;
    let usersChart = null;
    let db = null;

    const categoryIcons = {
      weapons: "fa-crosshairs",
      food: "fa-apple-alt",
      medicine: "fa-plus-square",
      tools: "fa-wrench",
      clothing: "fa-tshirt",
      materials: "fa-boxes",
      ammunition: "fa-bomb",
      fuel: "fa-gas-pump",
      electronics: "fa-microchip",
      books: "fa-book",
      containers: "fa-box-open",
      other: "fa-question-circle"
    };

    const categoryNames = {
      weapons: "Armes",
      food: "Nourriture",
      medicine: "Médicaments",
      tools: "Outils",
      clothing: "Vêtements",
      materials: "Matériaux",
      ammunition: "Munitions",
      fuel: "Carburant",
      electronics: "Électronique",
      books: "Livres",
      containers: "Contenants",
      other: "Autres"
    };

    // Fonction Toast Notification
    function showToast(title, message, type = "success") {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      if (!toast || !toastMessage) return;

      toastMessage.textContent = message;
      const icon = toast.querySelector('i');
      if (icon) {
        icon.className = "fas fa-info-circle fa-lg";
        if (type === "success") icon.className = "fas fa-check-circle fa-lg";
        if (type === "error") icon.className = "fas fa-exclamation-circle fa-lg";
      }

      toast.classList.remove("success", "error", "info");
      toast.classList.add("show", type);

      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }

    // Thème : toggle dark/light
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);

      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      if (themeToggleBtn) {
        themeToggleBtn.innerHTML = newTheme === 'dark'
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
      }

      localStorage.setItem('theme', newTheme);
      showToast("Thème", `Thème ${newTheme === 'dark' ? 'sombre' : 'clair'} activé`, "success");
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Appliquer le thème sauvegardé
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);

      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      if (themeToggleBtn) {
        themeToggleBtn.innerHTML = savedTheme === 'dark'
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
        themeToggleBtn.addEventListener('click', toggleTheme);
      }
    });

    // Affiche l'inventaire à l'écran
    function renderInventory(inventoryData) {
      const inventoryElement = document.getElementById('inventory');
      if (!inventoryElement || !inventoryData || !inventoryData[currentStorage]) return;

      inventoryElement.innerHTML = '';
      const inventory = inventoryData[currentStorage];
      let hasItems = false;

      for (const category in inventory) {
        const items = inventory[category] || [];

        if (activeFilter !== 'all' && category !== activeFilter) continue;

        const filteredItems = items.filter(item =>
          item && item.name &&
          (item.name.toLowerCase().includes(searchQuery) ||
          (item.description && item.description.toLowerCase().includes(searchQuery)))
        );

        if (filteredItems.length === 0) continue;
        hasItems = true;

        const categorySection = document.createElement('div');
        categorySection.className = 'category-section';
        categorySection.dataset.category = category;

        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'category-header';
        categoryHeader.innerHTML = `
          <div>
            <i class="fas ${categoryIcons[category]} category-icon"></i>
            ${categoryNames[category]}
            <span class="badge badge-primary">${filteredItems.length}</span>
          </div>
          <i class="fas fa-chevron-down toggle-collapse"></i>
        `;
        categoryHeader.onclick = () => toggleCategoryCollapse(categorySection);
        categorySection.appendChild(categoryHeader);

        const categoryContent = document.createElement('div');
        categoryContent.className = 'category-content';

        const table = document.createElement('table');
        table.className = 'inventory-table';

        table.innerHTML = `
          <thead>
            <tr>
              <th>Objet</th>
              <th>Quantité</th>
              <th>Actions</th>
            </tr>
          </thead>
        `;

        const tbody = document.createElement('tbody');

        filteredItems.forEach((item, index) => {
          if (!item) return;
          const actualIndex = items.indexOf(item);
          const tr = document.createElement('tr');
          if (item.priority) tr.className = `priority-${item.priority}`;

          tr.innerHTML = `
            <td class="item-name">
              <i class="fas ${categoryIcons[category]} item-icon"></i>
              ${item.name}
              ${item.description ? `<div class="tooltip"><i class="fas fa-info-circle"></i><span class="tooltiptext">${item.description}</span></div>` : ''}
            </td>
            <td><span class="counter-display">${item.count}</span></td>
            <td class="item-actions">
              <button class="action-btn" onclick="decreaseCount('${category}', ${actualIndex})"><i class="fas fa-minus"></i></button>
              <button class="action-btn add" onclick="increaseCount('${category}', ${actualIndex})"><i class="fas fa-plus"></i></button>
              <button class="action-btn delete" onclick="removeItem('${category}', ${actualIndex})"><i class="fas fa-trash"></i></button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        categoryContent.appendChild(table);
        categorySection.appendChild(categoryContent);
        inventoryElement.appendChild(categorySection);
      }

      if (!hasItems) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
          <i class="fas fa-box-open"></i>
          <p>Votre inventaire est vide ou aucun objet ne correspond à la recherche.</p>
        `;
        inventoryElement.appendChild(emptyState);
      }
    }

    // Ajouter un objet
    function addItem() {
      const name = document.getElementById('item-name').value.trim();
      const category = document.getElementById('item-category').value;
      const count = parseInt(document.getElementById('item-count').value);
      const description = document.getElementById('item-description').value.trim();
      const priority = document.getElementById('item-priority').value;

      if (!name) return showToast("Erreur", "Nom d'objet requis", "error");
      if (isNaN(count) || count < 1) return showToast("Erreur", "Quantité invalide", "error");
      if (!inventoryRef) return showToast("Erreur", "Base de données non connectée", "error");

      const categoryRef = inventoryRef.child(`${currentStorage}/${category}`);

      categoryRef.once('value', snapshot => {
        const items = snapshot.val() || [];
        const existingIndex = items.findIndex(item => item.name.toLowerCase() === name.toLowerCase());

        if (existingIndex !== -1) {
          const newCount = items[existingIndex].count + count;
          categoryRef.child(existingIndex).update({ count: newCount });
          showToast("Mise à jour", `Quantité de ${name} augmentée`, "success");
        } else {
          const newItem = {
            name, count, description, priority,
            addedOn: firebase.database.ServerValue.TIMESTAMP
          };
          items.push(newItem);
          categoryRef.set(items);
          showToast("Ajouté", `${count} ${name} ajouté`, "success");
        }

        document.getElementById('item-name').value = '';
        document.getElementById('item-count').value = '1';
        document.getElementById('item-description').value = '';
        document.getElementById('item-priority').value = 'normal';
      });
    }

    // Supprimer un objet
    function removeItem(category, index) {
      const ref = inventoryRef.child(`${currentStorage}/${category}`);
      ref.once('value', snapshot => {
        const items = snapshot.val() || [];
        if (index >= 0 && index < items.length) {
          items.splice(index, 1);
          ref.set(items);
          showToast("Supprimé", "Objet supprimé", "success");
        }
      });
    }

    // Incrémenter/décrémenter la quantité
    function increaseCount(category, index) {
      updateCount(category, index, +1);
    }

    function decreaseCount(category, index) {
      updateCount(category, index, -1);
    }

    function updateCount(category, index, delta) {
      const ref = inventoryRef.child(`${currentStorage}/${category}/${index}`);
      ref.once('value', snapshot => {
        const item = snapshot.val();
        if (!item) return;

        const newCount = item.count + delta;
        if (newCount <= 0) {
          removeItem(category, index);
        } else {
          ref.update({ count: newCount });
        }
      });
    }

    // Met à jour les statistiques globales
    function updateStats(data) {
      if (!data || !data[currentStorage]) return;
      const statsElement = document.getElementById('stats');
      if (!statsElement) return;

      const inventory = data[currentStorage];
      let totalItems = 0;
      let totalCategories = 0;

      for (const category in inventory) {
        const items = inventory[category] || [];
        const total = items.reduce((acc, item) => acc + (item.count || 0), 0);
        if (total > 0) totalCategories++;
        totalItems += total;
      }

      statsElement.innerHTML = `
        <div class="stat-box"><i class="fas fa-layer-group"></i><span>${totalCategories}</span><p>Catégories</p></div>
        <div class="stat-box"><i class="fas fa-cubes"></i><span>${totalItems}</span><p>Objets</p></div>
      `;
    }

    // Gère la recherche dans l'inventaire
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', e => {
          searchQuery = e.target.value.toLowerCase();
          inventoryRef.once('value', snapshot => {
            renderInventory(snapshot.val());
          });
        });
      }
    });

    // Changement de filtre (catégorie)
    function changeFilter(category) {
      activeFilter = category;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      const btn = document.querySelector(`.filter-btn[data-category="${category}"]`);
      if (btn) btn.classList.add('active');

      inventoryRef.once('value', snapshot => {
        renderInventory(snapshot.val());
      });
    }

    // Reset filtre et recherche
    function resetFilters() {
      searchQuery = '';
      activeFilter = 'all';
      const input = document.getElementById('search-input');
      if (input) input.value = '';
      changeFilter('all');
    }

    // Collapse / Expand une catégorie
    function toggleCategoryCollapse(categorySection) {
      const content = categorySection.querySelector('.category-content');
      const icon = categorySection.querySelector('.fa-chevron-down');
      if (!content || !icon) return;
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
      icon.classList.toggle('rotated');
    }

    // Génération du QR Code de partage
    function generateQRCode() {
      const container = document.getElementById('qrcode');
      if (!container || !currentRoomId) return;

      container.innerHTML = '';
      const shareURL = `${location.origin}${location.pathname}?room=${currentRoomId}`;

      new QRCode(container, {
        text: shareURL,
        width: 200,
        height: 200,
        colorDark: "#c62828",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });

      showToast("QR Code", "QR Code généré avec succès", "success");
    }

    // Lier le bouton de génération
    document.addEventListener('DOMContentLoaded', () => {
      const qrBtn = document.getElementById('generate-qrcode-btn');
      if (qrBtn) {
        qrBtn.addEventListener('click', generateQRCode);
      }
    });

    // Initialiser le graphe des ressources
    function initStatsCharts() {
      const canvas = document.createElement('canvas');
      canvas.id = 'resources-chart';
      canvas.style.width = '100%';
      canvas.style.maxHeight = '300px';

      const section = document.createElement('section');
      section.innerHTML = '<h2>Statistiques des Ressources</h2>';
      section.appendChild(canvas);

      const main = document.querySelector('main');
      if (main) main.appendChild(section);

      const ctx = canvas.getContext('2d');
      resourcesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Armes', 'Nourriture', 'Médicaments'],
          datasets: [{
            label: 'Objets',
            data: [0, 0, 0],
            backgroundColor: ['#c62828', '#43a047', '#1e88e5']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#f5f5f5' }
            },
            x: {
              ticks: { color: '#f5f5f5' }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#f5f5f5'
              }
            }
          }
        }
      });
    }

    // Mettre à jour les stats dans le graphe
    function updateStatsCharts() {
      if (!resourcesChart || !inventoryRef) return;

      inventoryRef.once('value', snapshot => {
        const data = snapshot.val();
        const inv = data?.[currentStorage] || {};
        let weapons = 0, food = 0, meds = 0;

        inv.weapons?.forEach(item => weapons += item.count || 0);
        inv.food?.forEach(item => food += item.count || 0);
        inv.medicine?.forEach(item => meds += item.count || 0);

        resourcesChart.data.datasets[0].data = [weapons, food, meds];
        resourcesChart.update();
      });
    }

    // Initialisation globale
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      currentRoomId = params.get('room') || 'default-room';
      userName = prompt("Entrez votre pseudo :", "Survivant") || "Survivant";

      inventoryRef = database.ref(`rooms/${currentRoomId}/inventory`);
      mapMarkersRef = database.ref(`rooms/${currentRoomId}/mapMarkers`);
      activityLogRef = database.ref(`rooms/${currentRoomId}/activity`);

      inventoryRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        renderInventory(data);
        updateStats(data);
        updateStatsCharts();
      });

      // Créer la structure si elle n'existe pas
      inventoryRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          const base = {
            weapons: [], food: [], medicine: [], tools: [],
            clothing: [], materials: [], ammunition: [],
            fuel: [], electronics: [], books: [],
            containers: [], other: []
          };
          inventoryRef.child(currentStorage).set(base);
        }
      });

      initStatsCharts();
    });
  </script>
</body>
</html>
