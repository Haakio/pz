                storagePhotosRef.child(`${currentStorage}/${photoId}`).remove()
                    .then(() => {
                        showToast("Succès", "Photo supprimée avec succès", "success");
                        addActivityLog("a supprimé", "une photo de l'emplacement");
                    })
                    .catch(error => {
                        showToast("Erreur", "Échec de la suppression de la photo", "error");
                        console.error("Erreur de suppression:", error);
                    });
            }
        }

        // Fonction pour éditer la légende d'une photo
        function editPhotoCaption(photoId, currentCaption) {
            if (!storagePhotosRef) return;
            
            const newCaption = prompt("Entrez une légende pour cette photo:", currentCaption || "");
            
            if (newCaption !== null) {
                storagePhotosRef.child(`${currentStorage}/${photoId}`).update({
                    caption: newCaption
                })
                .then(() => {
                    showToast("Succès", "Légende mise à jour", "success");
                })
                .catch(error => {
                    showToast("Erreur", "Échec de la mise à jour de la légende", "error");
                    console.error("Erreur de mise à jour:", error);
                });
            }
        }

        // Ouvrir une photo en mode plein écran
        function openPhotoModal(url, caption) {
            const modal = document.createElement('div');
            modal.className = 'overlay active';
            modal.id = 'photo-modal';
            
            modal.innerHTML = `
                <div class="modal photo-modal">
                    <button class="modal-close" onclick="closeModal('photo-modal')"><i class="fas fa-times"></i></button>
                    <img src="${url}" alt="Photo plein écran" style="max-width: 100%; max-height: 80vh;">
                    ${caption ? `<p class="photo-caption">${caption}</p>` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Fonction pour mettre à jour les recettes de crafting
        function updateCraftingRecipes() {
            const recipeContainer = document.getElementById('recipe-container');
            if (!recipeContainer || !inventoryRef) return;
            
            recipeContainer.innerHTML = '';
            
            // Obtenir l'inventaire actuel
            inventoryRef.child(currentStorage).once('value', snapshot => {
                const inventory = snapshot.val() || {};
                const availableItems = {};
                
                // Créer un dictionnaire des objets disponibles et de leurs quantités
                Object.keys(inventory).forEach(category => {
                    (inventory[category] || []).forEach(item => {
                        if (item && item.name) {
                            availableItems[item.name] = (availableItems[item.name] || 0) + item.count;
                        }
                    });
                });
                
                // Vérifier quelles recettes sont disponibles
                craftingRecipes.forEach(recipe => {
                    const canCraft = recipe.ingredients.every(ingredient => 
                        (availableItems[ingredient.item] || 0) >= ingredient.count
                    );
                    
                    const recipeElement = document.createElement('div');
                    recipeElement.className = `recipe-card ${canCraft ? 'available' : 'unavailable'}`;
                    recipeElement.dataset.category = recipe.category;
                    
                    recipeElement.innerHTML = `
                        <div class="recipe-header">
                            <h3>${recipe.name}</h3>
                            <span class="recipe-status">${canCraft ? '✅ Disponible' : '❌ Indisponible'}</span>
                        </div>
                        <p>${recipe.description}</p>
                        <div class="recipe-ingredients">
                            <h4>Ingrédients requis:</h4>
                            <ul>
                                ${recipe.ingredients.map(ingredient => `
                                    <li class="${(availableItems[ingredient.item] || 0) >= ingredient.count ? 'available' : 'missing'}">
                                        ${ingredient.count} x ${ingredient.item} 
                                        <span class="ingredient-count">(${availableItems[ingredient.item] || 0} disponible${(availableItems[ingredient.item] || 0) > 1 ? 's' : ''})</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        ${canCraft ? `<button class="btn craft-btn" onclick="craftItem('${recipe.id}')">Fabriquer</button>` : ''}
                    `;
                    
                    recipeContainer.appendChild(recipeElement);
                });
                
                // Ajouter les écouteurs pour les filtres de recettes
                document.querySelectorAll('.recipe-filters .filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const category = btn.dataset.category;
                        
                        // Mettre à jour les boutons actifs
                        document.querySelectorAll('.recipe-filters .filter-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        btn.classList.add('active');
                        
                        // Filtrer les recettes
                        document.querySelectorAll('.recipe-card').forEach(card => {
                            if (category === 'all' || card.dataset.category === category) {
                                card.style.display = 'block';
                            } else {
                                card.style.display = 'none';
                            }
                        });
                    });
                });
            });
        }

        // Fonction pour fabriquer un objet
        function craftItem(recipeId) {
            if (!inventoryRef) return;
            
            const recipe = craftingRecipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Obtenir l'inventaire actuel
            inventoryRef.child(currentStorage).once('value', snapshot => {
                const inventory = snapshot.val() || {};
                
                // Vérifier si tous les ingrédients sont disponibles
                const availableItems = {};
                Object.keys(inventory).forEach(category => {
                    (inventory[category] || []).forEach(item => {
                        if (item && item.name) {
                            availableItems[item.name] = (availableItems[item.name] || 0) + item.count;
                        }
                    });
                });
                
                const canCraft = recipe.ingredients.every(ingredient => 
                    (availableItems[ingredient.item] || 0) >= ingredient.count
                );
                
                if (!canCraft) {
                    showToast("Erreur", "Ingrédients insuffisants pour fabriquer cet objet", "error");
                    return;
                }
                
                // Consommer les ingrédients
                recipe.ingredients.forEach(ingredient => {
                    // Trouver les objets correspondants dans l'inventaire
                    Object.keys(inventory).forEach(category => {
                        const items = inventory[category] || [];
                        items.forEach((item, index) => {
                            if (item && item.name === ingredient.item) {
                                const newCount = item.count - ingredient.count;
                                
                                if (newCount <= 0) {
                                    // Supprimer l'objet s'il n'en reste plus
                                    removeItem(category, index);
                                } else {
                                    // Mettre à jour la quantité
                                    const itemPath = `${currentStorage}/${category}/${index}`;
                                    inventoryRef.child(itemPath).update({ count: newCount });
                                }
                            }
                        });
                    });
                });
                
                // Ajouter l'objet fabriqué à l'inventaire
                const categoryRef = inventoryRef.child(`${currentStorage}/${recipe.category}`);
                
                const newItem = {
                    name: recipe.name,
                    count: 1,
                    description: `Fabriqué avec ${recipe.ingredients.map(i => i.item).join(', ')}`,
                    priority: 'normal',
                    addedOn: firebase.database.ServerValue.TIMESTAMP
                };
                
                categoryRef.once('value', snapshot => {
                    const currentItems = snapshot.val() || [];
                    currentItems.push(newItem);
                    categoryRef.set(currentItems);
                    
                    showToast("Fabriqué", `${recipe.name} a été fabriqué avec succès`, "success");
                    addActivityLog("a fabriqué", recipe.name);
                });
            });
        }

        // Fonction pour générer un code QR
        function generateQRCode() {
            if (!currentRoomId) {
                showToast("Erreur", "Vous devez d'abord rejoindre un inventaire", "error");
                return;
            }
            
            // Construire l'URL de partage
            const shareURL = `${window.location.origin}${window.location.pathname}?room=${currentRoomId}`;
            
            // Générer le code QR
            const qrcodeContainer = document.getElementById('qrcode');
            if (!qrcodeContainer) return;
            
            qrcodeContainer.innerHTML = '';
            
            try {
                new QRCode(qrcodeContainer, {
                    text: shareURL,
                    width: 256,
                    height: 256,
                    colorDark: "#c62828",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Afficher le modal
                openModal('qrcode-modal');
            } catch (error) {
                console.error("Erreur lors de la génération du QR code:", error);
                showToast("Erreur", "Impossible de générer le QR code", "error");
            }
        }

        // Fonction pour télécharger le code QR
        function saveQRCode() {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) {
                showToast("Erreur", "QR code non généré", "error");
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.download = `zomboid-inventory-${currentRoomId}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast("Succès", "QR code téléchargé", "success");
            } catch (error) {
                console.error("Erreur lors du téléchargement:", error);
                showToast("Erreur", "Impossible de télécharger le QR code", "error");
            }
        }

        // Fonction pour partager le code QR
        function shareQRCode() {
            if (!navigator.share) {
                showToast("Erreur", "Votre navigateur ne prend pas en charge le partage", "error");
                return;
            }
            
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) {
                showToast("Erreur", "QR code non généré", "error");
                return;
            }
            
            try {
                canvas.toBlob(blob => {
                    if (!blob) {
                        showToast("Erreur", "Impossible de créer l'image", "error");
                        return;
                    }
                    
                    const file = new File([blob], "zomboid-inventory.png", { type: "image/png" });
                    
                    navigator.share({
                        title: "Inventaire Project Zomboid",
                        text: `Rejoignez mon inventaire Project Zomboid avec le code ${currentRoomId}`,
                        files: [file]
                    }).catch(error => {
                        console.error("Erreur lors du partage:", error);
                        showToast("Erreur", "Problème lors du partage", "error");
                    });
                });
            } catch (error) {
                console.error("Erreur lors du partage:", error);
                showToast("Erreur", "Problème lors du partage", "error");
            }
        }
        
        // Fonction pour sauvegarder l'inventaire localement
        function saveLocalInventory(inventory) {
            if (!db) return;
            
            try {
                const transaction = db.transaction(['inventory'], 'readwrite');
                const store = transaction.objectStore('inventory');
                
                store.put({
                    id: 'local_inventory',
                    data: inventory,
                    timestamp: Date.now()
                });
                
                // Sauvegarder aussi dans localStorage comme backup
                localStorage.setItem('localInventory', JSON.stringify(inventory));
            } catch (error) {
                console.error("Erreur lors de la sauvegarde locale:", error);
            }
        }
        
        // Ajouter des modifications en attente pour le mode hors ligne
        function addPendingChange(operation, path, data) {
            if (!db) {
                console.error("IndexedDB non initialisé");
                return;
            }
            
            try {
                const transaction = db.transaction(['pendingChanges'], 'readwrite');
                const store = transaction.objectStore('pendingChanges');
                
                store.add({
                    operation: operation, // 'set', 'update', 'push', 'remove'
                    path: path,
                    data: data,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error("Erreur lors de l'ajout d'une modification en attente:", error);
            }
        }

        // Synchroniser les modifications en attente
        function syncPendingChanges() {
            if (!db || !navigator.onLine) return;
            
            try {
                const transaction = db.transaction(['pendingChanges'], 'readwrite');
                const store = transaction.objectStore('pendingChanges');
                
                store.openCursor().onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const change = cursor.value;
                        
                        // Appliquer le changement à Firebase
                        let ref = database;
                        const pathParts = change.path.split('/');
                        pathParts.forEach(part => {
                            if (part) ref = ref.child(part);
                        });
                        
                        switch (change.operation) {
                            case 'set':
                                ref.set(change.data);
                                break;
                            case 'update':
                                ref.update(change.data);
                                break;
                            case 'push':
                                ref.push(change.data);
                                break;
                            case 'remove':
                                ref.remove();
                                break;
                        }
                        
                        // Supprimer ce changement de la file d'attente
                        cursor.delete();
                        cursor.continue();
                    } else {
                        showToast("Synchronisé", "Toutes les modifications ont été synchronisées", "success");
                    }
                };
            } catch (error) {
                console.error("Erreur lors de la synchronisation des modifications:", error);
            }
        }
        
        // Fonction pour forcer un rafraîchissement de l'inventaire
        function refreshInventory() {
            document.body.classList.add('loading');
            showToast("Rafraîchissement", "Mise à jour de l'inventaire...", "success");
            
            // Forcer la récupération des données depuis Firebase
            if (inventoryRef) {
                inventoryRef.once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            renderInventory(snapshot.val());
                            updateStats(snapshot.val());
                            showToast("Terminé", "Inventaire mis à jour avec succès", "success");
                        } else {
                            showToast("Erreur", "Aucune donnée d'inventaire trouvée", "error");
                        }
                        document.body.classList.remove('loading');
                    })
                    .catch(error => {
                        console.error("Erreur lors du rafraîchissement:", error);
                        showToast("Erreur", "Problème lors de la mise à jour", "error");
                        document.body.classList.remove('loading');
                    });
            } else {
                showToast("Erreur", "Connexion à la base de données non établie", "error");
                document.body.classList.remove('loading');
            }
        }
        
        // Initialiser l'inventaire
        function initializeInventory() {
            if (!inventoryRef) return;
            
            const defaultInventory = {
                main: {
                    weapons: [],
                    food: [],
                    medicine: [],
                    tools: [],
                    clothing: [],
                    materials: [],
                    ammunition: [],
                    fuel: [],
                    electronics: [],
                    books: [],
                    containers: [],
                    other: []
                }
            };
            
            inventoryRef.set(defaultInventory);
        }
        
        // Initialiser les emplacements de stockage
        function initializeStorageLocations() {
            if (!storageLocationsRef) return;
            
            const defaultStorageLocations = [
                { id: 'main', name: 'Inventaire principal', icon: 'fa-user' }
            ];
            
            storageLocationsRef.set(defaultStorageLocations);
        }
        
        // Fonction pour ajouter une entrée au journal d'activité
        function addActivityLog(action, details) {
            if (!activityLogRef) return;
            
            activityLogRef.push({
                time: firebase.database.ServerValue.TIMESTAMP,
                user: userName,
                action: action,
                details: details
            });
        }
        
        // Afficher le journal d'activité
        function renderActivityLog(logEntries) {
            const logContainer = document.getElementById('log-entries');
            if (!logContainer) return;
            
            logContainer.innerHTML = '';
            
            if (!logEntries || Object.keys(logEntries).length === 0) {
                const emptyLog = document.createElement('div');
                emptyLog.className = 'log-entry';
                emptyLog.textContent = 'Aucune activité récente';
                logContainer.appendChild(emptyLog);
                return;
            }
            
            // Convertir l'objet en tableau pour pouvoir le trier
            const entries = Object.entries(logEntries).map(([key, value]) => ({
                id: key,
                ...value
            }));
            
            // Trier les entrées par horodatage (du plus récent au plus ancien)
            entries.sort((a, b) => b.time - a.time);
            
            // Afficher les 10 dernières entrées
            entries.slice(0, 10).forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const time = new Date(entry.time);
                const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                
                logEntry.innerHTML = `
                    <span class="log-time">${timeString}</span>
                    <span class="log-user">${entry.user}</span> 
                    ${entry.action} ${entry.details}
                `;
                
                logContainer.appendChild(logEntry);
            });
        }
        
        // Fonction pour ajouter un nouvel objet
        function addItem() {
            const name = document.getElementById('item-name').value.trim();
            const category = document.getElementById('item-category').value;
            const count = parseInt(document.getElementById('item-count').value);
            const description = document.getElementById('item-description').value.trim();
            const priority = document.getElementById('item-priority').value;
            
            if (!name) {
                showToast("Erreur", "Veuillez entrer un nom d'objet", "error");
                return;
            }
            
            if (isNaN(count) || count < 1) {
                showToast("Erreur", "Veuillez entrer une quantité valide", "error");
                return;
            }
            
            // Vérifier si nous sommes hors ligne
            if (!navigator.onLine) {
                // Sauvegarder localement
                addPendingChange('push', `rooms/${currentRoomId}/inventory/${currentStorage}/${category}`, {
                    name: name,
                    count: count,
                    description: description,
                    priority: priority,
                    addedOn: Date.now()
                });
                
                // Mettre à jour l'interface
                const localInventory = JSON.parse(localStorage.getItem('localInventory') || '{}');
                if (!localInventory[currentStorage]) localInventory[currentStorage] = {};
                if (!localInventory[currentStorage][category]) localInventory[currentStorage][category] = [];
                
                localInventory[currentStorage][category].push({
                    name: name,
                    count: count,
                    description: description,
                    priority: priority,
                    addedOn: Date.now()
                });
                localStorage.setItem('localInventory', JSON.stringify(localInventory));
                
                renderInventory(localInventory);
                updateStats(localInventory);
                
                showToast("Ajouté (hors-ligne)", `${count} ${name} ajouté à l'inventaire local`, "success");
                
                // Réinitialiser le formulaire
                document.getElementById('item-name').value = '';
                document.getElementById('item-count').value = '1';
                document.getElementById('item-description').value = '';
                document.getElementById('item-priority').value = 'normal';
                
                return;
            }
            
            if (!inventoryRef) {
                showToast("Erreur", "Connexion à la base de données non établie", "error");
                return;
            }
            
            // Référence à la catégorie actuelle
            const categoryRef = inventoryRef.child(`${currentStorage}/${category}`);
            
            // Vérifier si l'objet existe déjà
            categoryRef.once('value', snapshot => {
                const items = snapshot.val() || [];
                const existingItemIndex = items.findIndex(item => 
                    item && item.name && item.name.toLowerCase() === name.toLowerCase()
                );
                
                if (existingItemIndex !== -1) {
                    // Mettre à jour la quantité si l'objet existe déjà
                    const newCount = items[existingItemIndex].count + count;
                    categoryRef.child(existingItemIndex).update({ count: newCount });
                    
                    showToast("Mise à jour", `Quantité de ${name} augmentée de ${count}`, "success");
                    addActivityLog("a ajouté", `${count} ${name}`);
                } else {
                    // Ajouter un nouvel objet
                    const newItem = {
                        name: name,
                        count: count,
                        description: description,
                        priority: priority,
                        addedOn: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Ajouter à la fin du tableau
                    categoryRef.once('value', snapshot => {
                        const currentItems = snapshot.val() || [];
                        currentItems.push(newItem);
                        categoryRef.set(currentItems);
                        
                        showToast("Ajouté", `${count} ${name} ajouté à l'inventaire`, "success");
                        addActivityLog("a ajouté", `${count} ${name}`);
                    });
                }
                
                // Réinitialiser le formulaire
                document.getElementById('item-name').value = '';
                document.getElementById('item-count').value = '1';
                document.getElementById('item-description').value = '';
                document.getElementById('item-priority').value = 'normal';
            });
        }
        
        // Fonction pour l'ajout rapide d'objets
        function quickAddItem(name, category) {
            document.getElementById('item-name').value = name;
            document.getElementById('item-category').value = category;
            document.getElementById('item-count').value = '1';
            document.getElementById('item-priority').value = 'normal';
            
            // Focus sur le champ quantité pour permettre une modification rapide
            document.getElementById('item-count').focus();
            document.getElementById('item-count').select();
        }
        
        // Fonction pour retirer un objet
        function removeItem(category, index) {
            if (!inventoryRef) return;
            
            // Obtenir le nom de l'objet pour le journal
            inventoryRef.child(`${currentStorage}/${category}/${index}/name`).once('value', snapshot => {
                const itemName = snapshot.val() || 'Objet inconnu';
                
                // Récupérer la liste complète des objets de cette catégorie
                inventoryRef.child(`${currentStorage}/${category}`).once('value', snapshot => {
                    let items = snapshot.val() || [];
                    
                    // Si items n'est pas un tableau, le convertir en tableau
                    if (!Array.isArray(items)) {
                        items = [];
                    }
                    
                    // Supprimer l'élément à l'index spécifié
                    if (index >= 0 && index < items.length) {
                        items.splice(index, 1);
                    }
                    
                    // Si nous supprimons le dernier élément, utiliser un tableau vide explicite
                    if (items.length === 0) {
                        items = [];
                    }
                    
                    // Mettre à jour la catégorie entière
                    inventoryRef.child(`${currentStorage}/${category}`).set(items)
                    .then(() => {
                        // Forcer un rafraîchissement immédiat de l'interface
                        refreshInventory();
                        
                        showToast("Supprimé", `${itemName} retiré de l'inventaire`, "success");
                        addActivityLog("a supprimé", itemName);
                    })
                    .catch(error => {
                        console.error("Erreur lors de la suppression:", error);
                        showToast("Erreur", "Problème lors de la suppression de l'objet", "error");
                    });
                });
            });
        }
        
        // Fonction pour augmenter la quantité
        function increaseCount(category, index) {
            if (!inventoryRef) return;
            
            const itemRef = inventoryRef.child(`${currentStorage}/${category}/${index}`);
            
            itemRef.once('value', snapshot => {
                const item = snapshot.val();
                if (item) {
                    itemRef.update({ count: item.count + 1 });
                    addActivityLog("a augmenté", `${item.name} (+1)`);
                }
            });
        }
        
        // Fonction pour diminuer la quantité
        function decreaseCount(category, index) {
            if (!inventoryRef) return;
            
            const itemRef = inventoryRef.child(`${currentStorage}/${category}/${index}`);
            
            itemRef.once('value', snapshot => {
                const item = snapshot.val();
                if (item) {
                    if (item.count > 1) {
                        itemRef.update({ count: item.count - 1 });
                        addActivityLog("a diminué", `${item.name} (-1)`);
                    } else {
                        removeItem(category, index);
                    }
                }
            });
        }
        
        // Fonction pour filtrer les objets
        function filterItems() {
            searchQuery = document.getElementById('search-input').value.toLowerCase();
            renderInventory();
        }
        
        // Fonction pour définir le filtre de catégorie
        function setCategoryFilter(filter) {
            activeFilter = filter;
            
            // Mettre à jour les boutons de filtre
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.category === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            renderInventory();
        }
        
        // Fonction pour afficher l'inventaire
        function renderInventory(inventoryData) {
            const inventoryElement = document.getElementById('inventory');
            if (!inventoryElement) return;
            
            inventoryElement.innerHTML = '';
            
            if (!inventoryData) return;
            
            const inventory = inventoryData[currentStorage];
            if (!inventory) return;
            
            let hasItems = false;
            
            // Parcourir chaque catégorie
            for (const category in inventory) {
                // Ignorer cette catégorie si un filtre est actif
                if (activeFilter !== 'all' && category !== activeFilter) continue;
                
                // Filtrer les objets en fonction de la recherche
                const items = inventory[category] || [];
                const filteredItems = items.filter(item => 
                    item && item.name && (
                        item.name.toLowerCase().includes(searchQuery) || 
                        (item.description && item.description.toLowerCase().includes(searchQuery))
                    )
                );
                
                // Ne pas afficher les catégories vides après filtrage
                if (filteredItems.length === 0) continue;
                
                hasItems = true;
                
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.dataset.category = category;
                
                // Ajouter l'en-tête de la catégorie
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.innerHTML = `
                    <div>
                        <i class="fas ${categoryIcons[category]} category-icon"></i>
                        ${categoryNames[category]}
                        <span class="badge badge-primary">${filteredItems.length}</span>
                    </div>
                    <i class="fas fa-chevron-down toggle-collapse"></i>
                `;
                categoryHeader.onclick = () => toggleCategoryCollapse(categorySection);
                categorySection.appendChild(categoryHeader);
                
                // Contenu de la catégorie
                const categoryContent = document.createElement('div');
                categoryContent.className = 'category-content';
                
                // Ajouter le tableau d'objets
                const table = document.createElement('table');
                table.className = 'inventory-table';
                
                // En-tête du tableau
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Objet</th>
                        <th>Quantité</th>
                        <th>Actions</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Corps du tableau
                const tbody = document.createElement('tbody');
                
                // Ajouter chaque objet
                // Ajouter chaque objet
                filteredItems.forEach((item, index) => {
                    if (!item) return; // Ignorer les éléments nuls
                    
                    const actualIndex = items.indexOf(item); // Index réel dans la liste complète
                    const tr = document.createElement('tr');
                    
                    // Ajouter la classe de priorité si elle existe
                    if (item.priority) {
                        tr.className = `priority-${item.priority}`;
                    }
                    
                    tr.innerHTML = `
                        <td class="item-name">
                            <i class="fas ${categoryIcons[category]} item-icon"></i>
                            ${item.name}
                            ${item.description ? `<div class="tooltip"><i class="fas fa-info-circle"></i><span class="tooltiptext">${item.description}</span></div>` : ''}
                        </td>
                        <td>
                            <span class="counter-display">${item.count}</span>
                        </td>
                        <td class="item-actions">
                            <button class="action-btn" onclick="decreaseCount('${category}', ${actualIndex})">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="action-btn add" onclick="increaseCount('${category}', ${actualIndex})">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="action-btn delete" onclick="removeItem('${category}', ${actualIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                table.appendChild(tbody);
                categoryContent.appendChild(table);
                categorySection.appendChild(categoryContent);
                
                inventoryElement.appendChild(categorySection);
            }
            
            // Afficher un message si aucun objet ne correspond
            if (!hasItems) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                
                if (searchQuery || activeFilter !== 'all') {
                    emptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <p>Aucun objet ne correspond à votre recherche</p>
                        <button class="btn" onclick="resetFilters()">Réinitialiser les filtres</button>
                    `;
                } else {
                    emptyState.innerHTML = `
                        <i class="fas fa-box-open"></i>
                        <p>Votre inventaire est vide</p>
                        <p>Ajoutez des objets à l'aide du formulaire à gauche</p>
                    `;
                }
                
                inventoryElement.appendChild(emptyState);
            }
        }
        
        // Fonction pour réinitialiser les filtres
        function resetFilters() {
            document.getElementById('search-input').value = '';
            searchQuery = '';
            setCategoryFilter('all');
        }
        
        // Fonction pour basculer l'état de pliage d'une catégorie
        function toggleCategoryCollapse(categorySection) {
            categorySection.classList.toggle('collapsed');
        }
        
        // Fonction pour mettre à jour les statistiques
        function updateStats(inventoryData) {
            if (!inventoryData) return;
            
            const inventory = inventoryData[currentStorage];
            if (!inventory) return;
            
            // Calculer le nombre total d'objets
            let totalItems = 0;
            let totalWeapons = 0;
            let totalFood = 0;
            let nonEmptyCategories = 0;
            
            for (const category in inventory) {
                const items = inventory[category] || [];
                const categoryCount = items.reduce((sum, item) => sum + (item ? item.count : 0), 0);
                totalItems += categoryCount;
                
                if (items.length > 0) {
                    nonEmptyCategories++;
                }
                
                if (category === 'weapons') {
                    totalWeapons = categoryCount;
                } else if (category === 'food') {
                    totalFood = categoryCount;
                }
            }
            
            // Mettre à jour les affichages
            const totalItemsElement = document.getElementById('total-items');
            const totalWeaponsElement = document.getElementById('total-weapons');
            const totalFoodElement = document.getElementById('total-food');
            const totalCategoriesElement = document.getElementById('total-categories');
            
            if (totalItemsElement) totalItemsElement.textContent = totalItems;
            if (totalWeaponsElement) totalWeaponsElement.textContent = totalWeapons;
            if (totalFoodElement) totalFoodElement.textContent = totalFood;
            if (totalCategoriesElement) totalCategoriesElement.textContent = nonEmptyCategories;
        }
        
        // Fonction pour ajouter un nouvel emplacement de stockage
        function addNewStorage() {
            if (!storageLocationsRef) return;
            
            const name = document.getElementById('storage-name').value.trim();
            const icon = document.getElementById('storage-icon').value;
            
            if (!name) {
                showToast("Erreur", "Veuillez entrer un nom pour l'emplacement", "error");
                return;
            }
            
            // Générer un ID unique
            const id = 'storage_' + Date.now();
            
            // Récupérer la liste actuelle des emplacements
            storageLocationsRef.once('value', snapshot => {
                const locations = snapshot.val() || [];
                
                // Ajouter le nouvel emplacement
                locations.push({
                    id: id,
                    name: name,
                    icon: icon
                });
                
                // Mettre à jour dans Firebase
                storageLocationsRef.set(locations);
                
                // Initialiser l'inventaire pour ce nouvel emplacement
                const defaultCategories = {
                    weapons: [],
                    food: [],
                    medicine: [],
                    tools: [],
                    clothing: [],
                    materials: [],
                    ammunition: [],
                    fuel: [],
                    electronics: [],
                    books: [],
                    containers: [],
                    other: []
                };
                
                inventoryRef.child(id).set(defaultCategories);
                
                // Fermer la modal
                closeModal('storage-modal');
                
                // Passer au nouvel emplacement
                switchStorage(id);
                
                showToast("Succès", `Nouvel emplacement "${name}" ajouté`, "success");
                addActivityLog("a créé", `un nouvel emplacement: ${name}`);
            });
        }
        
        // Fonction pour afficher les emplacements de stockage
        function renderStorageLocations(locations) {
            const container = document.getElementById('storage-selector');
            if (!container) return;
            
            if (!locations || !Array.isArray(locations)) return;
            
            // Vider le conteneur
            container.innerHTML = '';
            
            // Ajouter chaque emplacement
            locations.forEach(location => {
                const button = document.createElement('button');
                button.className = 'storage-btn' + (location.id === currentStorage ? ' active' : '');
                button.dataset.storage = location.id;
                button.onclick = () => switchStorage(location.id);
                
                button.innerHTML = `
                    <i class="fas ${location.icon}"></i> ${location.name}
                `;
                
                container.appendChild(button);
            });
            
            // Ajouter le bouton pour créer un nouvel emplacement
            const addButton = document.createElement('button');
            addButton.className = 'storage-btn add-storage-btn';
            addButton.onclick = () => openModal('storage-modal');
            addButton.innerHTML = '<i class="fas fa-plus"></i> Nouvel emplacement';
            
            container.appendChild(addButton);
            
            // Ajouter le bouton de génération de QR code
            const qrButton = document.createElement('button');
            qrButton.className = 'storage-btn';
            qrButton.onclick = generateQRCode;
            qrButton.innerHTML = '<i class="fas fa-qrcode"></i> Partager';
            
            container.appendChild(qrButton);
        }
        
        // Fonction pour changer d'emplacement de stockage
        function switchStorage(storageId) {
            currentStorage = storageId;
            
            // Mettre à jour l'interface
            document.querySelectorAll('.storage-btn').forEach(btn => {
                if (btn.dataset.storage === storageId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Interroger les données actuelles pour mettre à jour l'affichage
            if (inventoryRef) {
                inventoryRef.once('value', snapshot => {
                    if (snapshot.exists()) {
                        renderInventory(snapshot.val());
                        updateStats(snapshot.val());
                    }
                });
            }
            
            // Charger les photos du nouvel emplacement
            loadStoragePhotos();
            
            // Mettre à jour les recettes de crafting 
            updateCraftingRecipes();
            
            // Enregistrer cette action dans le journal
            if (storageLocationsRef) {
                storageLocationsRef.once('value', snapshot => {
                    const locations = snapshot.val() || [];
                    const currentLocation = locations.find(loc => loc.id === storageId);
                    
                    if (currentLocation) {
                        addActivityLog("a changé d'emplacement", `vers ${currentLocation.name}`);
                    }
                });
            }
        }
        
        // Fonction pour afficher une notification toast
        function showToast(title, message, type = "success") {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            if (!toast || !toastMessage) return;
            
            // Définir le contenu
            const toastTitle = toast.querySelector('.toast-title');
            if (toastTitle) toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Définir le type
            toast.className = "toast show";
            if (type === "success") {
                toast.classList.add("success");
                const icon = toast.querySelector('i');
                if (icon) icon.className = "fas fa-check-circle fa-lg";
            } else if (type === "error") {
                toast.classList.add("error");
                const icon = toast.querySelector('i');
                if (icon) icon.className = "fas fa-exclamation-circle fa-lg";
            } else if (type === "info") {
                toast.classList.add("info");
                const icon = toast.querySelector('i');
                if (icon) icon.className = "fas fa-info-circle fa-lg";
            }
            
            // Afficher le toast
            toast.classList.add("show");
            
            // Masquer automatiquement après 3 secondes
            setTimeout(hideToast, 3000);
        }
        
        // Fonction pour masquer le toast
        function hideToast() {
            const toast = document.getElementById('toast');
            if (toast) toast.classList.remove("show");
        }
        
        // Fonction pour ouvrir une modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('active');
        }
        
        // Fonction pour fermer une modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
            
            // Si c'est un modal photo qui a été créé dynamiquement, le supprimer
            if (modalId === 'photo-modal') {
                modal.parentNode.removeChild(modal);
            }
        }
        
        // Service Worker pour le mode hors-ligne
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('Service Worker enregistré:', registration);
                    })
                    .catch(function(error) {
                        console.log('Échec de l\'enregistrement du Service Worker:', error);
                    });
            }
        }
        
        // Écouter les changements d'état de connexion
        window.addEventListener('online', function() {
            showToast("Connecté", "Connexion internet rétablie", "success");
            syncPendingChanges();
        });

        window.addEventListener('offline', function() {
            showToast("Hors-ligne", "Mode hors-ligne activé", "error");
        });
        
        // Ajouter des écouteurs d'événements
        document.addEventListener('DOMContentLoaded', () => {
            // Appliquer le thème enregistré
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // Mettre à jour l'icône du thème
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            if (themeToggleBtn) {
                themeToggleBtn.innerHTML = savedTheme === 'dark' 
                    ? '<i class="fas fa-moon"></i>' 
                    : '<i class="fas fa-sun"></i>';
            }
            
            // Initialiser IndexedDB pour le mode hors ligne
            initIndexedDB();
            
            // Enregistrer le Service Worker
            registerServiceWorker();
            
            // Écouteurs pour les filtres de catégorie
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.category) {
                        setCategoryFilter(btn.dataset.category);
                    }
                });
            });
            
            // Écouteurs pour les filtres de recettes
            document.querySelectorAll('.recipe-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const category = btn.dataset.category;
                    if (!category) return;
                    
                    // Mettre à jour les boutons actifs
                    document.querySelectorAll('.recipe-filters .filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    // Filtrer les recettes
                    document.querySelectorAll('.recipe-card').forEach(card => {
                        if (category === 'all' || card.dataset.category === category) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });
            
            // Permettre d'appuyer sur Entrée pour rejoindre une salle
            const roomIdInput = document.getElementById('room-id');
            if (roomIdInput) {
                roomIdInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        joinRoom();
                    }
                });
            }
            
            const userNameInput = document.getElementById('user-name');
            if (userNameInput) {
                userNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        joinRoom();
                    }
                });
            }
            
            // Permettre d'appuyer sur Entrée pour ajouter un objet
            const itemNameInput = document.getElementById('item-name');
            if (itemNameInput) {
                itemNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addItem();
                    }
                });
            }
            
            const itemCountInput = document.getElementById('item-count');
            if (itemCountInput) {
                itemCountInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addItem();
                    }
                });
            }
            
            const itemDescriptionInput = document.getElementById('item-description');
            if (itemDescriptionInput) {
                itemDescriptionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addItem();
                    }
                });
            }
            
            // Vérifier s'il y a un code d'inventaire dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam && roomIdInput) {
                roomIdInput.value = roomParam;
                // Afficher un message pour informer l'utilisateur
                showToast("Code détecté", `Code d'inventaire "${roomParam}" détecté dans l'URL`, "info");
            }
        });
        
        // Fonction pour gérer les déconnexions
        window.addEventListener('beforeunload', () => {
            if (userPresenceRef) {
                userPresenceRef.remove();
            }
        });
    </script>
</body>
</html>        // Fonction pour basculer entre les thèmes sombre et clair
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            
            // Mettre à jour l'icône
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            themeToggleBtn.innerHTML = newTheme === 'dark' 
                ? '<i class="fas fa-moon"></i>' 
                : '<i class="fas fa-sun"></i>';
            
            // Sauvegarder la préférence
            localStorage.setItem('theme', newTheme);
            
            showToast("Thème", `Thème ${newTheme === 'dark' ? 'sombre' : 'clair'} activé`, "success");
        }

        // Initialisation d'IndexedDB pour le mode hors ligne
        function initIndexedDB() {
            const request = indexedDB.open('zomboidInventoryDB', 1);
            
            request.onerror = function(event) {
                console.error("Erreur d'ouverture de la base de données:", event.target.error);
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // Créer des object stores pour les différentes données
                if (!db.objectStoreNames.contains('inventory')) {
                    db.createObjectStore('inventory', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('pendingChanges')) {
                    db.createObjectStore('pendingChanges', { autoIncrement: true });
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log("IndexedDB initialisé avec succès");
            };
        }
        
        // Fonction pour rejoindre une salle
        function joinRoom() {
            const roomId = document.getElementById('room-id').value.trim();
            if (!roomId) {
                showToast("Erreur", "Veuillez entrer un code d'inventaire", "error");
                return;
            }
            
            // Vérifier si le nom d'utilisateur est fourni
            const inputUserName = document.getElementById('user-name').value.trim();
            if (inputUserName) {
                userName = inputUserName;
            } else {
                userName = 'Utilisateur ' + Math.floor(Math.random() * 1000);
            }
            
            // Définir la référence à la salle actuelle
            currentRoomId = roomId;
            
            // Mettre à jour l'affichage
            document.getElementById('current-room-display').textContent = `Inventaire partagé: ${roomId}`;
            
            // Fermer la modal
            document.getElementById('room-modal').classList.remove('active');
            
            // Démarrer Firebase
            setupFirebase();
            
            // Afficher un toast de bienvenue
            showToast("Connecté", `Vous avez rejoint l'inventaire "${roomId}"`, "success");
        }
        
        // Configurer les écouteurs Firebase et initialiser l'application
        function setupFirebase() {
            // Référence à l'inventaire actuel
            inventoryRef = database.ref(`rooms/${currentRoomId}/inventory`);
            
            // Référence aux emplacements de stockage
            storageLocationsRef = database.ref(`rooms/${currentRoomId}/storageLocations`);
            
            // Référence aux utilisateurs connectés
            userListRef = database.ref(`rooms/${currentRoomId}/users`);
            
            // Référence au journal d'activité
            activityLogRef = database.ref(`rooms/${currentRoomId}/activityLog`);

            // Référence aux photos de stockage
            storagePhotosRef = database.ref(`rooms/${currentRoomId}/storagePhotos`);

            // Référence aux marqueurs de carte
            mapMarkersRef = database.ref(`rooms/${currentRoomId}/mapMarkers`);
            
            // Référence à l'historique d'inventaire pour les statistiques
            inventoryHistoryRef = database.ref(`rooms/${currentRoomId}/inventoryHistory`);
            
            // Gérer la présence de l'utilisateur
            userPresenceRef = userListRef.push({
                name: userName,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Supprimer l'utilisateur quand il se déconnecte
            userPresenceRef.onDisconnect().remove();
            
            // Écouter les changements d'inventaire - au niveau supérieur
            inventoryRef.on('value', snapshot => {
                if (snapshot.exists()) {
                    renderInventory(snapshot.val());
                    updateStats(snapshot.val());
                    
                    // Sauvegarder l'état actuel dans l'historique
                    saveInventoryHistory(snapshot.val());
                    
                    // Mettre à jour les recettes de crafting
                    updateCraftingRecipes();
                    
                    // Vérifier les niveaux d'inventaire pour les notifications
                    checkInventoryLevels();
                } else {
                    // Initialiser l'inventaire s'il n'existe pas
                    initializeInventory();
                }
            });
            
            // Écouter les changements d'emplacements de stockage
            storageLocationsRef.on('value', snapshot => {
                if (snapshot.exists()) {
                    renderStorageLocations(snapshot.val());
                } else {
                    // Initialiser les emplacements s'ils n'existent pas
                    initializeStorageLocations();
                }
            });
            
            // Écouter les changements dans la liste des utilisateurs
            userListRef.on('value', snapshot => {
                const users = snapshot.val() || {};
                const count = Object.keys(users).length;
                document.getElementById('online-count').textContent = count;
            });
            
            // Écouter les entrées du journal d'activité
            activityLogRef.limitToLast(10).on('value', snapshot => {
                renderActivityLog(snapshot.val() || {});
            });

            // Charger les photos de l'emplacement actuel
            loadStoragePhotos();
            
            // Initialiser la carte interactive
            initMap();
            
            // Initialiser les graphiques de statistiques
            initStatsCharts();
            
            // Mettre à jour l'heure de dernière activité périodiquement
            setInterval(() => {
                if (userPresenceRef) {
                    userPresenceRef.update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }, 60000); // Chaque minute
        }

        // Demander la permission pour les notifications
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showToast("Erreur", "Ce navigateur ne prend pas en charge les notifications", "error");
                return;
            }
            
            if (Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showToast("Succès", "Notifications activées", "success");
                        checkInventoryLevels();
                    }
                });
            }
        }

        // Sauvegarder les paramètres d'alerte
        function saveAlertSettings() {
            const settings = {
                foodThreshold: parseInt(document.getElementById('alert-food').value) || 10,
                medicineThreshold: parseInt(document.getElementById('alert-medicine').value) || 5,
                weaponsThreshold: parseInt(document.getElementById('alert-weapons').value) || 3,
                notificationsEnabled: document.getElementById('enable-notifications').checked
            };
            
            // Sauvegarder dans Firebase
            database.ref(`rooms/${currentRoomId}/alertSettings`).set(settings)
                .then(() => {
                    showToast("Succès", "Paramètres d'alerte sauvegardés", "success");
                    
                    // Si les notifications sont activées, demander la permission
                    if (settings.notificationsEnabled) {
                        requestNotificationPermission();
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la sauvegarde des paramètres:", error);
                    showToast("Erreur", "Problème lors de la sauvegarde", "error");
                });
        }

        // Vérifier les niveaux d'inventaire et envoyer des notifications si nécessaire
        function checkInventoryLevels() {
            if (!inventoryRef) return;
            
            // Vérifier si les notifications sont activées
            database.ref(`rooms/${currentRoomId}/alertSettings`).once('value', settingsSnapshot => {
                const settings = settingsSnapshot.val() || {
                    foodThreshold: 10,
                    medicineThreshold: 5,
                    weaponsThreshold: 3,
                    notificationsEnabled: true
                };
                
                if (!settings.notificationsEnabled || Notification.permission !== "granted") {
                    return;
                }
                
                // Vérifier les niveaux d'inventaire
                inventoryRef.once('value', snapshot => {
                    const inventory = snapshot.val() || {};
                    let totalFood = 0, totalMedicine = 0, totalWeapons = 0;
                    
                    // Calculer les totaux pour toutes les catégories d'inventaire
                    Object.values(inventory).forEach(storage => {
                        totalFood += (storage.food || []).reduce((sum, item) => sum + (item ? item.count : 0), 0);
                        totalMedicine += (storage.medicine || []).reduce((sum, item) => sum + (item ? item.count : 0), 0);
                        totalWeapons += (storage.weapons || []).reduce((sum, item) => sum + (item ? item.count : 0), 0);
                    });
                    
                    // Vérifier les seuils et envoyer des notifications
                    const alerts = [];
                    
                    if (totalFood <= settings.foodThreshold) {
                        alerts.push(`Alerte: Il ne reste que ${totalFood} nourriture!`);
                    }
                    
                    if (totalMedicine <= settings.medicineThreshold) {
                        alerts.push(`Alerte: Il ne reste que ${totalMedicine} médicaments!`);
                    }
                    
                    if (totalWeapons <= settings.weaponsThreshold) {
                        alerts.push(`Alerte: Il ne reste que ${totalWeapons} armes!`);
                    }
                    
                    // Envoyer les notifications
                    alerts.forEach(message => {
                        new Notification('Project Zomboid Tracker', {
                            body: message,
                            icon: '/favicon.ico'
                        });
                    });
                });
            });
        }

        // Fonction pour sauvegarder l'état actuel de l'inventaire dans l'historique
        function saveInventoryHistory(inventory) {
            if (!inventoryHistoryRef) return;
            
            const timestamp = Date.now();
            inventoryHistoryRef.child(timestamp).set(inventory);
            
            // Nettoyer les anciennes données d'historique (garder seulement 90 jours)
            const cutoffTime = timestamp - (90 * 24 * 60 * 60 * 1000);
            inventoryHistoryRef.orderByKey().endAt(cutoffTime.toString()).once('value', snapshot => {
                const outdatedEntries = snapshot.val();
                if (outdatedEntries) {
                    const updates = {};
                    Object.keys(outdatedEntries).forEach(key => {
                        updates[key] = null;
                    });
                    inventoryHistoryRef.update(updates);
                }
            });
        }

        // Initialiser la carte interactive
        function initMap() {
            const mapElement = document.getElementById('resource-map');
            if (!mapElement) return; // Sortir si l'élément n'existe pas
            
            // Utiliser une image de carte de Project Zomboid comme base
            const mapBounds = [[0, 0], [10000, 10000]];
            zomboidMap = L.map('resource-map', {
                crs: L.CRS.Simple,
                minZoom: -2
            });
            
            // Création d'une simple carte avec des tuiles OpenStreetMap (pour démonstration)
            // Dans une implémentation réelle, vous utiliseriez l'image de carte du jeu
            try {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(zomboidMap);
                
                zomboidMap.fitBounds([
                    [0, 0],
                    [50, 50]
                ]);
                
                // Charger les marqueurs existants
                loadMapMarkers();
                
                // Ajouter un écouteur de clic pour placer de nouveaux marqueurs
                zomboidMap.on('click', function(e) {
                    showMapMarkerForm(e.latlng);
                });
            } catch (error) {
                console.error("Erreur d'initialisation de la carte:", error);
                showToast("Erreur", "Problème lors de l'initialisation de la carte", "error");
            }
        }

        // Charger les marqueurs existants sur la carte
        function loadMapMarkers() {
            if (!mapMarkersRef || !zomboidMap) return;
            
            mapMarkersRef.on('value', snapshot => {
                // Effacer tous les marqueurs existants
                zomboidMap.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        zomboidMap.removeLayer(layer);
                    }
                });
                
                const markers = snapshot.val() || {};
                
                // Ajouter chaque marqueur à la carte
                Object.entries(markers).forEach(([key, markerData]) => {
                    const marker = L.marker([markerData.lat, markerData.lng]).addTo(zomboidMap);
                    marker.bindPopup(`
                        <strong>${markerData.type}</strong><br>
                        ${markerData.description}<br>
                        <small>Ajouté par: ${markerData.addedBy}</small>
                    `);
                    
                    // Stocker l'ID de Firebase dans les données du marqueur
                    marker.markerId = key;
                    marker.markerType = markerData.type;
                    
                    // Ajouter un gestionnaire d'événements pour supprimer le marqueur
                    marker.on('contextmenu', function(e) {
                        if (confirm("Voulez-vous supprimer ce marqueur?")) {
                            mapMarkersRef.child(this.markerId).remove();
                        }
                    });
                });
            });
        }

        // Afficher le formulaire pour ajouter un marqueur
        function showMapMarkerForm(position) {
            if (!zomboidMap) return;
            
            // Position temporaire pour le nouveau marqueur
            const tempMarker = L.marker(position).addTo(zomboidMap);
            
            // Créer un popup avec le formulaire
            const popupContent = `
                <div class="marker-form">
                    <h3>Ajouter un marqueur</h3>
                    <div class="form-group">
                        <label>Type:</label>
                        <select id="marker-type" class="form-control">
                            <option value="food">Nourriture</option>
                            <option value="weapons">Armes</option>
                            <option value="shelter">Abri</option>
                            <option value="danger">Danger</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <input type="text" id="marker-description" class="form-control" placeholder="Décrivez cet emplacement">
                    </div>
                    <button onclick="saveMapMarker(${position.lat}, ${position.lng})" class="btn btn-success">Ajouter</button>
                    <button onclick="cancelMapMarker()" class="btn">Annuler</button>
                </div>
            `;
            
            tempMarker.bindPopup(popupContent).openPopup();
            window.tempMarker = tempMarker; // Stocker dans une variable globale pour y accéder plus tard
        }

        // Sauvegarder un nouveau marqueur
        function saveMapMarker(lat, lng) {
            if (!mapMarkersRef || !window.tempMarker) return;
            
            const type = document.getElementById('marker-type').value;
            const description = document.getElementById('marker-description').value;
            
            // Stocker dans Firebase
            const markerData = {
                lat: lat,
                lng: lng,
                type: type,
                description: description,
                addedBy: userName,
                addedOn: firebase.database.ServerValue.TIMESTAMP
            };
            
            mapMarkersRef.push(markerData);
            
            // Supprimer le marqueur temporaire
            zomboidMap.removeLayer(window.tempMarker);
            window.tempMarker = null;
            
            showToast("Succès", "Marqueur ajouté à la carte", "success");
        }

        // Annuler l'ajout d'un marqueur
        function cancelMapMarker() {
            if (!zomboidMap || !window.tempMarker) return;
            
            // Supprimer le marqueur temporaire
            zomboidMap.removeLayer(window.tempMarker);
            window.tempMarker = null;
        }

        // Filtrer les marqueurs sur la carte
        function filterMapMarkers() {
            if (!zomboidMap) return;
            
            const filterValue = document.getElementById('map-filter').value;
            
            // Parcourir tous les marqueurs et les afficher ou les cacher selon le filtre
            zomboidMap.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    if (filterValue === 'all' || layer.markerType === filterValue) {
                        layer.addTo(zomboidMap);
                    } else {
                        zomboidMap.removeLayer(layer);
                    }
                }
            });
            
            // Si des marqueurs ont été supprimés, les recharger
            if (filterValue === 'all') {
                loadMapMarkers();
            }
        }

        // Initialiser les graphiques de statistiques
        function initStatsCharts() {
            try {
                // Graphique d'évolution des ressources
                const resourcesCtx = document.getElementById('resources-chart');
                if (resourcesCtx) {
                    resourcesChart = new Chart(resourcesCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
                
                // Graphique de répartition par catégorie
                const categoriesCtx = document.getElementById('categories-chart');
                if (categoriesCtx) {
                    categoriesChart = new Chart(categoriesCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: []
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
                
                // Graphique d'activité des utilisateurs
                const usersCtx = document.getElementById('users-chart');
                if (usersCtx) {
                    usersChart = new Chart(usersCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Actions',
                                data: [],
                                backgroundColor: 'rgba(198, 40, 40, 0.5)',
                                borderColor: 'rgba(198, 40, 40, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
                
                // Mettre à jour les graphiques
                updateStatsCharts();
            } catch (error) {
                console.error("Erreur d'initialisation des graphiques:", error);
            }
        }

        // Mettre à jour les graphiques statistiques
        function updateStatsCharts() {
            if (!inventoryHistoryRef || !resourcesChart || !categoriesChart || !usersChart) return;
            
            const period = parseInt(document.getElementById('stats-period').value) || 7;
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - period);
            
            // Récupérer l'historique des inventaires
            inventoryHistoryRef.once('value', snapshot => {
                const history = snapshot.val() || {};
                
                // Filtrer les données par période
                const filteredHistory = Object.entries(history)
                    .filter(([timestamp, _]) => parseInt(timestamp) > startDate.getTime())
                    .sort(([a, _a], [b, _b]) => parseInt(a) - parseInt(b));
                
                // Préparer les données pour le graphique d'évolution
                const labels = [];
                const weaponsData = [];
                const foodData = [];
                const medicineData = [];
                
                filteredHistory.forEach(([timestamp, data]) => {
                    const date = new Date(parseInt(timestamp));
                    labels.push(`${date.getDate()}/${date.getMonth() + 1}`);
                    
                    let weaponsCount = 0, foodCount = 0, medicineCount = 0;
                    
                    // Calculer les totaux pour chaque catégorie
                    Object.values(data).forEach(storage => {
                        weaponsCount += (storage.weapons || []).reduce((sum, item) => sum + (item ? item.count : 0), 0);
                        foodCount += (storage.food || []).reduce((sum, item) => sum + (item ? item.count : 0), 0);
                        medicineCount += (storage.medicine || []).reduce((sum, item) => sum + (item ? item.count : 0), 0);
                    });
                    
                    weaponsData.push(weaponsCount);
                    foodData.push(foodCount);
                    medicineData.push(medicineCount);
                });
                
                // Mettre à jour le graphique d'évolution
                resourcesChart.data.labels = labels;
                resourcesChart.data.datasets = [
                    {
                        label: 'Armes',
                        data: weaponsData,
                        borderColor: '#e53935',
                        backgroundColor: 'rgba(229, 57, 53, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Nourriture',
                        data: foodData,
                        borderColor: '#43a047',
                        backgroundColor: 'rgba(67, 160, 71, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Médicaments',
                        data: medicineData,
                        borderColor: '#1e88e5',
                        backgroundColor: 'rgba(30, 136, 229, 0.1)',
                        tension: 0.4
                    }
                ];
                resourcesChart.update();
                
                // Préparer les données pour le graphique de répartition par catégorie
                // (utilisez la dernière entrée de l'historique pour la répartition actuelle)
                if (filteredHistory.length > 0) {
                    const latestData = filteredHistory[filteredHistory.length - 1][1];
                    const categoryTotals = {};
                    const categoryColors = {
                        weapons: '#e53935',
                        food: '#43a047',
                        medicine: '#1e88e5',
                        tools: '#fb8c00',
                        clothing: '#8e24aa',
                        materials: '#546e7a',
                        ammunition: '#f4511e',
                        electronics: '#00acc1',
                        other: '#757575'
                    };
                    
                    // Calculer les totaux pour chaque catégorie
                    Object.values(latestData).forEach(storage => {
                        Object.entries(storage).forEach(([category, items]) => {
                            if (!Array.isArray(items)) return;
                            
                            categoryTotals[category] = (categoryTotals[category] || 0) + 
                                items.reduce((sum, item) => sum + (item ? item.count : 0), 0);
                        });
                    });
                    
                    // Mettre à jour le graphique de répartition
                    categoriesChart.data.labels = Object.keys(categoryTotals).map(cat => categoryNames[cat] || cat);
                    categoriesChart.data.datasets[0].data = Object.values(categoryTotals);
                    categoriesChart.data.datasets[0].backgroundColor = Object.keys(categoryTotals).map(cat => categoryColors[cat] || '#757575');
                    categoriesChart.update();
                }
            });
            
            // Récupérer les données d'activité des utilisateurs
            if (activityLogRef) {
                activityLogRef.once('value', snapshot => {
                    const activityLog = snapshot.val() || {};
                    
                    // Filtrer les données par période
                    const filteredLog = Object.entries(activityLog)
                        .filter(([_, entry]) => entry.time > startDate.getTime());
                    
                    // Compter les actions par utilisateur
                    const userActions = {};
                    filteredLog.forEach(([_, entry]) => {
                        userActions[entry.user] = (userActions[entry.user] || 0) + 1;
                    });
                    
                    // Mettre à jour le graphique d'activité
                    usersChart.data.labels = Object.keys(userActions);
                    usersChart.data.datasets[0].data = Object.values(userActions);
                    usersChart.update();
                });
            }
        }

        // Fonction pour télécharger des photos pour un emplacement
        function uploadStoragePhoto(event) {
            if (!storagePhotosRef || !storage) {
                showToast("Erreur", "Module de stockage Firebase non disponible", "error");
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            // Afficher un indicateur de chargement
            showToast("Chargement", "Téléchargement de l'image en cours...", "info");
            
            try {
                // Créer une référence dans le stockage
                const storageRef = storage.ref(`rooms/${currentRoomId}/storage-photos/${currentStorage}/${Date.now()}_${file.name}`);
                
                // Télécharger le fichier
                const uploadTask = storageRef.put(file);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Progression du téléchargement
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Téléchargement: ' + progress + '%');
                    },
                    (error) => {
                        // Erreur
                        showToast("Erreur", "Échec du téléchargement de l'image", "error");
                        console.error("Erreur de téléchargement:", error);
                    },
                    () => {
                        // Succès
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            // Enregistrer l'URL dans Firebase Database
                            const photoData = {
                                url: downloadURL,
                                addedBy: userName,
                                addedOn: firebase.database.ServerValue.TIMESTAMP,
                                caption: ''
                            };
                            
                            storagePhotosRef.child(currentStorage).push(photoData)
                                .then(() => {
                                    showToast("Succès", "Image téléchargée avec succès", "success");
                                    addActivityLog("a ajouté", "une photo à l'emplacement");
                                });
                        });
                    }
                );
            } catch (error) {
                console.error("Erreur lors du téléchargement:", error);
                showToast("Erreur", "Problème lors du téléchargement", "error");
            }
        }

        // Fonction pour charger les photos d'un emplacement
        function loadStoragePhotos() {
            const galleryContainer = document.getElementById('gallery-container');
            if (!galleryContainer || !storagePhotosRef) return;
            
            galleryContainer.innerHTML = '';
            
            storagePhotosRef.child(currentStorage).on('value', snapshot => {
                const photos = snapshot.val() || {};
                
                if (Object.keys(photos).length === 0) {
                    galleryContainer.innerHTML = '<p class="empty-gallery">Aucune photo pour cet emplacement</p>';
                    return;
                }
                
                Object.entries(photos).forEach(([key, photo]) => {
                    const photoElement = document.createElement('div');
                    photoElement.className = 'gallery-item';
                    photoElement.innerHTML = `
                        <img src="${photo.url}" alt="Photo de l'emplacement" onclick="openPhotoModal('${photo.url}', '${photo.caption || ''}')">
                        <div class="gallery-actions">
                            <button class="gallery-btn" onclick="deletePhoto('${key}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="gallery-btn" onclick="editPhotoCaption('${key}', '${photo.caption || ''}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    `;
                    
                    galleryContainer.appendChild(photoElement);
                });
            });
        }

        // Fonction pour supprimer une photo
        function deletePhoto(photoId) {
            if (!storagePhotosRef) return;
            
            if (confirm("Voulez-vous vraiment supprimer cette photo?")) {
                storagePhotosRef.child(`${currentStorage}/${photoId}`).remove()
                    <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traceur d'Inventaire Project Zomboid</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ajout de Leaflet pour les cartes interactives -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Ajout de Chart.js pour les statistiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Ajout de QRCode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #c62828;
            --primary-dark: #8e0000;
            --primary-light: #ff5f52;
            --secondary: #2e7d32;
            --background: #121212;
            --surface: #1e1e1e;
            --surface-light: #2a2a2a;
            --text: #f5f5f5;
            --text-secondary: #b0b0b0;
            --border-radius: 8px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- Loading spinner -->
    <div class="loader"></div>
    
    <!-- Toast notification system -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle fa-lg"></i>
        <div class="toast-content">
            <div class="toast-title">Succès</div>
            <div class="toast-message" id="toast-message"></div>
        </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- Leaflet pour les cartes -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyASp6Gfi4Fz8Nduap0on89oAZzCkPLKpFc",
            authDomain: "lions-890e9.firebaseapp.com",
            databaseURL: "https://lions-890e9-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lions-890e9",
            storageBucket: "lions-890e9.firebasestorage.app",
            messagingSenderId: "560777699926",
            appId: "1:560777699926:web:2e256d3d1d337513be91f7",
            measurementId: "G-ZX3N3XWJ4K"
        };
        
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Variables globales
        let currentRoomId = null;
        let currentStorage = 'main';
        let activeFilter = 'all';
        let searchQuery = '';
        let userName = 'Anonyme';
        let userPresenceRef = null;
        let inventoryRef = null;
        let userListRef = null;
        let activityLogRef = null;
        let storageLocationsRef = null;
        let storagePhotosRef = null;
        let mapMarkersRef = null;
        let inventoryHistoryRef = null;
        let zomboidMap = null;
        let resourcesChart = null;
        let categoriesChart = null; 
        let usersChart = null;
        let db = null; // Pour IndexedDB
        
        // Noms des catégories en français
        const categoryNames = {
            weapons: "Armes",
            food: "Nourriture",
            medicine: "Médicaments",
            tools: "Outils",
            clothing: "Vêtements",
            materials: "Matériaux",
            ammunition: "Munitions",
            fuel: "Carburant",
            electronics: "Électronique",
            books: "Livres",
            containers: "Containers",
            other: "Autres"
        };

        // Icônes pour chaque catégorie
        const categoryIcons = {
            weapons: "fa-knife",
            food: "fa-drumstick-bite",
            medicine: "fa-pills",
            tools: "fa-wrench",
            clothing: "fa-tshirt",
            materials: "fa-cube",
            ammunition: "fa-gun",
            fuel: "fa-gas-pump",
            electronics: "fa-laptop",
            books: "fa-book",
            containers: "fa-box",
            other: "fa-question"
        };

        // Base de données de recettes pour le crafting
        const craftingRecipes = [
            {
                id: 'molotov',
                name: 'Cocktail Molotov',
                ingredients: [
                    { item: 'Chiffon', count: 1 },
                    { item: 'Whisky', count: 1 }
                ],
                category: 'weapons',
                description: 'Arme incendiaire improvisée'
            },
            {
                id: 'bandage',
                name: 'Bandage',
                ingredients: [
                    { item: 'Draps', count: 1 }
                ],
                category: 'medicine',
                description: 'Pour soigner les blessures légères'
            },
            {
                id: 'spike_bat',
                name: 'Batte cloutée',
                ingredients: [
                    { item: 'Batte de baseball', count: 1 },
                    { item: 'Clous', count: 10 }
                ],
                category: 'weapons',
                description: 'Arme de mêlée améliorée'
            },
            {
                id: 'soup',
                name: 'Soupe aux légumes',
                ingredients: [
                    { item: 'Marmite', count: 1 },
                    { item: 'Légumes', count: 3 },
                    { item: 'Eau', count: 1 }
                ],
                category: 'food',
                description: 'Aliment nutritif chaud'
            }
        ];
        
        // Fonction pour basculer entre les thèmes sombre et clair
        function toggleTheme() {
            const currentTh
        <button class="toast-close" onclick="hideToast()"><i class="fas fa-times"></i></button>
    </div>
    
    <!-- Modal overlay for new storage -->
    <div class="overlay" id="storage-modal">
        <div class="modal">
            <h2 class="modal-title">Ajouter un nouvel emplacement</h2>
            <button class="modal-close" onclick="closeModal('storage-modal')"><i class="fas fa-times"></i></button>
            
            <div class="form-group">
                <label for="storage-name">Nom de l'emplacement</label>
                <input type="text" id="storage-name" class="form-control" placeholder="Ex: Coffre de la cuisine">
            </div>
            
            <div class="form-group">
                <label for="storage-icon">Icône</label>
                <select id="storage-icon" class="form-control">
                    <option value="fa-box">📦 Coffre</option>
                    <option value="fa-home">🏠 Maison</option>
                    <option value="fa-car">🚗 Véhicule</option>
                    <option value="fa-warehouse">🏭 Entrepôt</option>
                    <option value="fa-shopping-cart">🛒 Chariot</option>
                    <option value="fa-backpack">🎒 Sac à dos</option>
                </select>
            </div>
            
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('storage-modal')">Annuler</button>
                <button class="btn btn-success" onclick="addNewStorage()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal for QR Code sharing -->
    <div class="overlay" id="qrcode-modal">
        <div class="modal">
            <h2 class="modal-title">Partager cet inventaire</h2>
            <button class="modal-close" onclick="closeModal('qrcode-modal')"><i class="fas fa-times"></i></button>
            
            <div class="qrcode-container" id="qrcode"></div>
            
            <p class="qrcode-info">Scannez ce code QR pour rejoindre l'inventaire partagé</p>
            
            <div class="modal-footer">
                <button class="btn" onclick="saveQRCode()">
                    <i class="fas fa-download"></i> Télécharger
                </button>
                <button class="btn btn-success" onclick="shareQRCode()">
                    <i class="fas fa-share-alt"></i> Partager
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for room selection -->
    <div class="overlay active" id="room-modal">
        <div class="modal">
            <h2 class="modal-title">Rejoindre un inventaire partagé</h2>
            
            <div class="form-group">
                <label for="room-id">Code d'inventaire</label>
                <div class="room-input">
                    <input type="text" id="room-id" class="form-control" placeholder="Entrez un code (ex: team123)">
                    <button class="btn join-room" onclick="joinRoom()"><i class="fas fa-sign-in-alt"></i> Rejoindre</button>
                </div>
                <small style="color: var(--text-secondary);">Entrez un code unique que vous pourrez partager avec votre équipe.</small>
            </div>
            
            <div class="form-group">
                <label for="user-name">Votre nom (optionnel)</label>
                <input type="text" id="user-name" class="form-control" placeholder="Comment vous identifier auprès des autres">
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <header>
            <!-- Theme toggle button -->
            <div class="theme-toggle">
                <button id="theme-toggle-btn" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            
            <div class="logo">
                <i class="fas fa-biohazard"></i>
                PROJECT ZOMBOID TRACKER
            </div>
            <div class="subtitle">Gérez facilement votre inventaire en situation d'apocalypse</div>
            <div class="room-name" id="current-room-display"></div>
            <div class="users-online" id="users-online">
                <i class="fas fa-circle"></i>
                <span id="online-count">0</span> utilisateurs connectés
            </div>
        </header>
        
        <div class="storage-selector" id="storage-selector">
            <button class="storage-btn active" data-storage="main" onclick="switchStorage('main')">
                <i class="fas fa-user"></i> Inventaire principal
            </button>
            <!-- Les autres emplacements seront ajoutés dynamiquement -->
            <button class="storage-btn add-storage-btn" onclick="openModal('storage-modal')">
                <i class="fas fa-plus"></i> Nouvel emplacement
            </button>
            <!-- Ajout du bouton de génération de QR code -->
            <button class="storage-btn" onclick="generateQRCode()">
                <i class="fas fa-qrcode"></i> Partager
            </button>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="total-items">0</div>
                <div class="stat-name">Objets total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-weapons">0</div>
                <div class="stat-name">Armes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-food">0</div>
                <div class="stat-name">Nourriture</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-categories">0</div>
                <div class="stat-name">Catégories</div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-plus-circle"></i> Ajouter un objet</h2>
                
                <div class="form-group">
                    <label for="item-name">Nom de l'objet</label>
                    <input type="text" id="item-name" class="form-control" placeholder="Ex: Marteau">
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="item-category">Catégorie</label>
                        <select id="item-category" class="form-control">
                            <option value="weapons">🔪 Armes</option>
                            <option value="food">🍗 Nourriture</option>
                            <option value="medicine">💊 Médicaments</option>
                            <option value="tools">🔧 Outils</option>
                            <option value="clothing">👕 Vêtements</option>
                            <option value="materials">🧱 Matériaux</option>
                            <option value="ammunition">🔫 Munitions</option>
                            <option value="fuel">⛽ Carburant</option>
                            <option value="electronics">💻 Électronique</option>
                            <option value="books">📚 Livres</option>
                            <option value="containers">📦 Containers</option>
                            <option value="other">🔮 Autres</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="item-count">Quantité</label>
                        <div class="input-group">
                            <input type="number" id="item-count" class="form-control quantity-input" value="1" min="1">
                            <div class="input-group-append">
                                <span class="input-group-text quantity-label">unités</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ajout du champ de priorité -->
                <div class="form-group">
                    <label for="item-priority">Priorité</label>
                    <select id="item-priority" class="form-control">
                        <option value="low">🔵 Basse</option>
                        <option value="normal" selected>⚪ Normale</option>
                        <option value="high">🟠 Haute</option>
                        <option value="critical">🔴 Critique</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="item-description">Description (optionnel)</label>
                    <input type="text" id="item-description" class="form-control" placeholder="Ex: En bon état, trouvé dans la maison au nord">
                </div>
                
                <button id="add-item" class="btn btn-block" onclick="addItem()">
                    <i class="fas fa-plus"></i> Ajouter à l'inventaire
                </button>
                
                <hr style="margin: 25px 0; border-color: #444;">
                
                <h3 class="quick-add-title">
                    <i class="fas fa-bolt"></i> Ajout rapide
                </h3>
                
                <div class="common-items">
                    <div class="common-item" onclick="quickAddItem('Marteau', 'tools')">
                        <i class="fas fa-hammer"></i>
                        <div class="common-item-name">Marteau</div>
                    </div>
                    <div class="common-item" onclick="quickAddItem('Conserve', 'food')">
                        <i class="fas fa-utensils"></i>
                        <div class="common-item-name">Conserve</div>
                    </div>
                    <div class="common-item" onclick="quickAddItem('Bandage', 'medicine')">
                        <i class="fas fa-band-aid"></i>
                        <div class="common-item-name">Bandage</div>
                    </div>
                    <div class="common-item" onclick="quickAddItem('Batte de baseball', 'weapons')">
                        <i class="fas fa-baseball-bat"></i>
                        <div class="common-item-name">Batte</div>
                    </div>
                    <div class="common-item" onclick="quickAddItem('T-shirt', 'clothing')">
                        <i class="fas fa-tshirt"></i>
                        <div class="common-item-name">T-shirt</div>
                    </div>
                    <div class="common-item" onclick="quickAddItem('Planches', 'materials')">
                        <i class="fas fa-wood"></i>
                        <div class="common-item-name">Planches</div>
                    </div>
                </div>

                <!-- Ajout des paramètres d'alerte -->
                <hr style="margin: 25px 0; border-color: #444;">
                
                <h3 class="quick-add-title">
                    <i class="fas fa-bell"></i> Paramètres d'alerte
                </h3>
                
                <div class="form-group">
                    <label for="alert-food">Seuil d'alerte pour la nourriture</label>
                    <input type="number" id="alert-food" class="form-control" value="10" min="0">
                </div>
                
                <div class="form-group">
                    <label for="alert-medicine">Seuil d'alerte pour les médicaments</label>
                    <input type="number" id="alert-medicine" class="form-control" value="5" min="0">
                </div>
                
                <div class="form-group">
                    <label for="alert-weapons">Seuil d'alerte pour les armes</label>
                    <input type="number" id="alert-weapons" class="form-control" value="3" min="0">
                </div>
                
                <div class="form-group">
                    <div class="checkbox-control">
                        <input type="checkbox" id="enable-notifications" checked>
                        <label for="enable-notifications">Activer les notifications push</label>
                    </div>
                </div>
                
                <button class="btn btn-block" onclick="saveAlertSettings()">
                    <i class="fas fa-save"></i> Enregistrer les paramètres
                </button>
            </div>
            
            <div class="panel">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" id="search-input" placeholder="Rechercher un objet..." oninput="filterItems()">
                </div>
                
                <div class="category-filter" id="category-filter">
                    <button class="filter-btn active" data-category="all">Tous</button>
                    <button class="filter-btn" data-category="weapons">Armes</button>
                    <button class="filter-btn" data-category="food">Nourriture</button>
                    <button class="filter-btn" data-category="medicine">Médicaments</button>
                    <button class="filter-btn" data-category="tools">Outils</button>
                    <button class="filter-btn" data-category="other">Autres</button>
                </div>
                
                <div class="refresh-container">
                    <button class="btn refresh-btn" onclick="refreshInventory()">
                        <i class="fas fa-sync-alt"></i> Rafraîchir l'inventaire
                    </button>
                </div>
                
                <div class="inventory-container" id="inventory">
                    <!-- Le contenu de l'inventaire sera généré dynamiquement -->
                </div>

                <div class="activity-log" id="activity-log">
                    <div class="activity-log-title">
                        <i class="fas fa-history"></i> Activité récente
                    </div>
                    <div id="log-entries">
                        <!-- Les entrées du journal seront ajoutées ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Nouvelle section pour la carte interactive -->
        <div class="panel map-panel">
            <h2 class="panel-title"><i class="fas fa-map"></i> Carte des ressources</h2>
            <div id="resource-map" class="resource-map"></div>
            <div class="map-controls">
                <button class="btn" onclick="addMapMarker()"><i class="fas fa-map-marker"></i> Ajouter un marqueur</button>
                <select id="map-filter" onchange="filterMapMarkers()">
                    <option value="all">Tous les marqueurs</option>
                    <option value="food">Nourriture</option>
                    <option value="weapons">Armes</option>
                    <option value="shelter">Abris</option>
                </select>
            </div>
        </div>

        <!-- Nouvelle section pour le crafting -->
        <div class="panel crafting-panel">
            <h2 class="panel-title"><i class="fas fa-hammer"></i> Crafting</h2>
            <div class="recipe-filters">
                <button class="filter-btn active" data-category="all">Tous</button>
                <button class="filter-btn" data-category="weapons">Armes</button>
                <button class="filter-btn" data-category="medicine">Médicaments</button>
                <button class="filter-btn" data-category="food">Nourriture</button>
            </div>
            <div id="recipe-container" class="recipe-container">
                <!-- Les recettes seront générées ici -->
            </div>
        </div>

        <!-- Nouvelle section pour les statistiques avancées -->
        <div class="panel stats-panel">
            <h2 class="panel-title"><i class="fas fa-chart-line"></i> Statistiques avancées</h2>
            
            <div class="stats-filters">
                <label for="stats-period">Période :</label>
                <select id="stats-period" onchange="updateStatsCharts()">
                    <option value="7">Derniers 7 jours</option>
                    <option value="30">Derniers 30 jours</option>
                    <option value="90">Derniers 3 mois</option>
                </select>
            </div>
            
            <div class="stats-grid">
                <div class="stats-card">
                    <h3>Évolution des ressources</h3>
                    <canvas id="resources-chart"></canvas>
                </div>
                
                <div class="stats-card">
                    <h3>Répartition par catégorie</h3>
                    <canvas id="categories-chart"></canvas>
                </div>
                
                <div class="stats-card">
                    <h3>Activité des utilisateurs</h3>
                    <canvas id="users-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Galerie de photos pour l'emplacement actuel -->
        <div class="panel">
            <h2 class="panel-title"><i class="fas fa-images"></i> Photos de l'emplacement</h2>
            <div id="gallery-container" class="gallery-container">
                <!-- Les photos seront affichées ici -->
            </div>
            <div class="gallery-upload">
                <label for="photo-upload" class="btn">
                    <i class="fas fa-upload"></i> Ajouter une photo
                </label>
                <input type="file" id="photo-upload" accept="image/*" style="display: none" onchange="uploadStoragePhoto(event)">
            </div>
        </div>
    </div>

        /* Variables pour le thème clair */
        [data-theme="light"] {
            --primary: #d32f2f;
            --primary-dark: #9a0007;
            --primary-light: #ff6659;
            --secondary: #388e3c;
            --background: #f5f5f5;
            --surface: #ffffff;
            --surface-light: #e0e0e0;
            --text: #212121;
            --text-secondary: #757575;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzEyMTIxMiI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSI1IiBjeT0iNSIgcj0iMSIgZmlsbD0iIzFlMWUxZSI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjE1IiBjeT0iMTUiIHI9IjEiIGZpbGw9IiMxZTFlMWUiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIxIiBmaWxsPSIjMWUxZTFlIj48L2NpcmNsZT4KPGNpcmNsZSBjeD0iMzUiIGN5PSIzNSIgcj0iMSIgZmlsbD0iIzFlMWUxZSI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjQ1IiBjeT0iNDUiIHI9IjEiIGZpbGw9IiMxZTFlMWUiPjwvY2lyY2xlPgo8L3N2Zz4=');
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            position: relative;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo i {
            margin-right: 15px;
            color: var(--primary);
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Ajout du sélecteur de thème */
        .theme-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
        }

        .theme-toggle button {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-toggle button:hover {
            background-color: var(--surface-light);
        }

        /* Styles pour les priorités d'objets */
        .priority-low { background-color: rgba(0, 0, 255, 0.1); }
        .priority-normal { background-color: transparent; }
        .priority-high { background-color: rgba(255, 165, 0, 0.1); }
        .priority-critical { background-color: rgba(255, 0, 0, 0.1); border-left: 3px solid #ff0000; }

        /* Styles pour la carte interactive */
        .resource-map {
            width: 100%;
            height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Styles pour la galerie de photos */
        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .gallery-item {
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            aspect-ratio: 1/1;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        .gallery-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gallery-btn:hover {
            background-color: var(--primary);
        }

        /* Styles pour les recettes de crafting */
        .recipe-card {
            background-color: var(--surface-light);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        .recipe-card.available {
            border-left: 3px solid var(--secondary);
        }

        .recipe-card.unavailable {
            border-left: 3px solid var(--text-secondary);
            opacity: 0.7;
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recipe-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .recipe-card.available .recipe-status {
            background-color: rgba(46, 125, 50, 0.2);
            color: #81c784;
        }

        .recipe-card.unavailable .recipe-status {
            background-color: rgba(198, 40, 40, 0.2);
            color: var(--primary-light);
        }

        .recipe-ingredients {
            margin-top: 10px;
        }

        .recipe-ingredients h4 {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .recipe-ingredients ul {
            list-style-type: none;
        }

        .recipe-ingredients li {
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .recipe-ingredients li.available {
            color: #81c784;
        }

        .recipe-ingredients li.missing {
            color: var(--primary-light);
        }

        .ingredient-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .craft-btn {
            margin-top: 10px;
            background-color: var(--secondary);
        }

        /* Styles pour les statistiques avancées */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stats-card {
            background-color: var(--surface-light);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        .stats-card h3 {
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid var(--primary-dark);
            padding-bottom: 5px;
        }

        .stats-card canvas {
            width: 100%;
            height: 250px;
        }

        .stats-filters {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Styles pour le QR code */
        .qrcode-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .qrcode-info {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-secondary);
        }

        /* Styles pour les alertes et notifications */
        .checkbox-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-control input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* Style pour le mode hors ligne */
        .offline-message {
            text-align: center;
            padding: 40px 20px;
            background-color: var(--surface);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        .offline-message i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .offline-message h2 {
            margin-bottom: 15px;
        }

        .offline-message p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* Style pour le toast info */
        .toast.info {
            border-left: 5px solid #2196F3;
        }

        .toast.info i {
            color: #2196F3;
        }

        /* Autres styles existants */
        .panel {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        }

        .panel-title {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-dark);
            display: flex;
            align-items: center;
        }

        .panel-title i {
            margin-right: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--surface-light);
            border: 1px solid #444;
            border-radius: var(--border-radius);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.25);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-success {
            background-color: var(--secondary);
        }

        .btn-success:hover {
            background-color: #1b5e20;
        }

        .input-group {
            display: flex;
            align-items: center;
        }

        .input-group .form-control {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        .input-group-append {
            display: flex;
        }

        .input-group-text {
            padding: 0 15px;
            background-color: var(--surface-light);
            border: 1px solid #444;
            border-left: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 15px;
            background-color: var(--surface-light);
            border: 1px solid #444;
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background-color: #3a3a3a;
            color: var(--text);
        }

        .filter-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        .inventory-container {
            margin-top: 20px;
        }

        .category-section {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .category-section:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
        }

        .category-header {
            padding: 15px 20px;
            background-color: rgba(198, 40, 40, 0.1);
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 5px solid var(--primary);
        }

        .category-header:hover {
            background-color: rgba(198, 40, 40, 0.2);
        }

        .category-header i {
            margin-right: 10px;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
        }

        .inventory-table th, 
        .inventory-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .inventory-table th {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .inventory-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: var(--surface-light);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background-color: #444;
            transform: scale(1.1);
        }

        .action-btn.delete {
            background-color: rgba(198, 40, 40, 0.2);
            color: var(--primary-light);
        }

        .action-btn.delete:hover {
            background-color: var(--primary);
            color: white;
        }

        .action-btn.add {
            background-color: rgba(46, 125, 50, 0.2);
            color: #81c784;
        }

        .action-btn.add:hover {
            background-color: var(--secondary);
            color: white;
        }

        .counter-display {
            background-color: var(--surface-light);
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .item-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .toggle-collapse {
            transition: transform 0.3s;
        }

        .collapsed .toggle-collapse {
            transform: rotate(-90deg);
        }

        .category-content {
            max-height: 800px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsed .category-content {
            max-height: 0;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .stat-name {
            font-size: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-container i {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            background-color: var(--surface);
            border: 1px solid #444;
            border-radius: var(--border-radius);
            color: var(--text);
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.25);
        }

        .common-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .common-item {
            background-color: var(--surface-light);
            border-radius: var(--border-radius);
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .common-item:hover {
            background-color: rgba(198, 40, 40, 0.2);
            transform: translateY(-2px);
        }

        .common-item i {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .common-item-name {
            font-size: 0.9rem;
        }

        /* Loading spinner */
        .loader {
            display: none;
            width: 48px;
            height: 48px;
            border: 5px solid var(--surface-light);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: rotation 1s linear infinite;
            z-index: 9999;
        }

        @keyframes rotation {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .loading {
            overflow: hidden;
        }

        .loading .loader {
            display: block;
        }

        .loading .app-container {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Dark overlay for modals */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-dark);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--primary);
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .item-quantity {
            font-weight: bold;
            color: var(--text);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-primary {
            background-color: rgba(198, 40, 40, 0.2);
            color: var(--primary-light);
        }

        .badge-secondary {
            background-color: rgba(46, 125, 50, 0.2);
            color: #81c784;
        }

        /* Icons for different categories */
        .category-icon {
            margin-right: 10px;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Connected users indicator */
        .users-online {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--surface);
            padding: 5px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .users-online i {
            color: #4CAF50;
            margin-right: 8px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .panel-title {
                font-size: 1.2rem;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .inventory-table th, 
            .inventory-table td {
                padding: 10px;
            }
        }

        /* Room selection */
        .room-selector {
            margin-bottom: 20px;
        }

        .room-input {
            display: flex;
            margin-bottom: 10px;
        }

        .room-input input {
            flex: 1;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        .room-input button {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .room-name {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .join-room {
            background-color: var(--secondary);
        }

        .join-room:hover {
            background-color: #1b5e20;
        }

        /* User actions */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-actions .user-name {
            background-color: var(--surface-light);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        /* Activity log */
        .activity-log {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            margin-top: 20px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .activity-log-title {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .activity-log-title i {
            margin-right: 8px;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--primary-light);
            margin-right: 5px;
            font-weight: bold;
        }

        .log-user {
            font-weight: bold;
            color: var(--text);
        }

        /* Refresh button styles */
        .refresh-container {
            text-align: right;
            margin-bottom: 15px;
        }

        .refresh-btn {
            padding: 8px 15px;
            background-color: var(--surface-light);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
        }

        .refresh-btn:hover {
            background-color: var(--primary);
        }

        .refresh-btn i {
            margin-right: 5px;
        }

        /* Fixed width for quantity input and label */
        .quantity-input {
            width: 70%;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        .quantity-label {
            width: 30%;
            text-align: center;
            justify-content: center;
            display: flex;
        }

        /* Empty gallery message */
        .empty-gallery {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Photo modal */
        .photo-modal {
            max-width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .photo-caption {
            margin-top: 15px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Styles for the marker form */
        .marker-form {
            padding: 10px;
        }

        .marker-form h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Storage button styles */
        .storage-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--surface);
            border-radius: var(--border-radius);
            overflow-x: auto;
        }

        .storage-btn {
            padding: 8px 15px;
            background-color: var(--surface-light);
            border: none;
            border-radius: 5px;
            color: var(--text);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .storage-btn:hover {
            background-color: #3a3a3a;
        }

        .storage-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .storage-btn i {
            margin-right: 8px;
        }

        .add-storage-btn {
            background-color: rgba(46, 125, 50, 0.2);
            color: #81c784;
        }

        .add-storage-btn:hover {
            background-color: var(--secondary);
            color: white;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Toast styles */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--surface);
            color: var(--text);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateY(150%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.success {
            border-left: 5px solid var(--secondary);
        }

        .toast.success i {
            color: var(--secondary);
        }

        .toast.error {
            border-left: 5px solid var(--primary);
        }

        .toast.error i {
            color: var(--primary);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .toast-message {
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .toast-close:hover {
            color: var(--text);
        }
